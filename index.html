<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a0a">
<title>HARD Messenger</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<noscript><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"></noscript>
<style>
:root{
  --bg:#0a0a0a;--p1:#101010;--p2:#141414;--p3:#1a1a1a;--p4:#202020;--p5:#2a2a2a;
  --red:#e53935;--red-d:#b71c1c;--red-l:#ef5350;
  --red-glow:rgba(229,57,53,.3);--red-dim:rgba(229,57,53,.08);--red-bdr:rgba(229,57,53,.2);
  --gold:#f0b429;--gold-glow:rgba(240,180,41,.35);--gold-dim:rgba(240,180,41,.08);--gold-bdr:rgba(240,180,41,.25);
  --txt:#e8e8e8;--txt2:#666;--txt3:#2e2e2e;
  --green:#43a047;
  --sab:env(safe-area-inset-bottom,0px);
  --sat:env(safe-area-inset-top,0px);
  --msg-radius:18px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);touch-action:manipulation;}
body{font-family:'DM Sans',sans-serif;color:var(--txt);display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ PARTICLES BG ‚îÄ‚îÄ */
#particles{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;}
.part{position:absolute;border-radius:50%;background:var(--red);opacity:0;animation:pfloat linear infinite;}
@keyframes pfloat{0%{transform:translateY(100vh) scale(0);opacity:0;}10%{opacity:.15;}90%{opacity:.05;}100%{transform:translateY(-20vh) scale(1);opacity:0;}}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#gload{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999;transition:opacity .5s;}
.gl-wordmark{font-family:'IBM Plex Mono',monospace;font-size:48px;font-weight:600;letter-spacing:.15em;color:var(--txt);animation:wmpulse 2s ease-in-out infinite;}
@keyframes wmpulse{0%,100%{text-shadow:0 0 0 transparent;}50%{text-shadow:0 0 40px var(--red-glow),0 0 80px rgba(229,57,53,.1);}}
.gl-line{width:48px;height:2px;background:var(--red);margin:16px auto 0;border-radius:1px;animation:glscale .8s ease-out forwards;width:0;}
@keyframes glscale{to{width:48px;}}
.gl-sub{font-size:10px;color:var(--txt3);letter-spacing:.3em;text-transform:uppercase;margin-top:12px;font-family:'IBM Plex Mono',monospace;animation:fadeIn 1s .4s forwards;opacity:0;}
@keyframes fadeIn{to{opacity:1;}}
.gl-progress{width:140px;height:1px;background:var(--p3);border-radius:1px;margin-top:24px;overflow:hidden;}
.gl-progress-fill{height:100%;background:var(--red);border-radius:1px;animation:progressFill 1s ease-out forwards;}
@keyframes progressFill{from{width:0;}to{width:100%;}}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
.auth-screen{display:none;position:fixed;inset:0;background:var(--bg);align-items:center;justify-content:center;z-index:200;padding:20px;overflow-y:auto;}
.auth-screen.on{display:flex;}
.auth-screen::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 600px 400px at 80% 20%,rgba(229,57,53,.06) 0%,transparent 70%),radial-gradient(ellipse 400px 600px at 20% 80%,rgba(229,57,53,.04) 0%,transparent 70%);pointer-events:none;}
.auth-card{width:100%;max-width:340px;animation:slideup .28s ease-out;position:relative;z-index:1;}
@keyframes slideup{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.a-brand{text-align:center;margin-bottom:32px;}
.a-brand-name{font-family:'IBM Plex Mono',monospace;font-size:40px;font-weight:600;letter-spacing:.15em;color:var(--txt);display:block;}
.a-brand-dot{display:inline-block;width:7px;height:7px;background:var(--red);border-radius:50%;margin-left:4px;vertical-align:middle;box-shadow:0 0 10px var(--red-glow);animation:dotblink 2s ease-in-out infinite;}
@keyframes dotblink{0%,100%{opacity:1;}50%{opacity:.2;}}
.a-brand-sub{font-size:11px;color:var(--txt3);letter-spacing:.2em;text-transform:uppercase;margin-top:8px;display:block;font-family:'IBM Plex Mono',monospace;}
.ff{margin-bottom:14px;}
.ff label{display:block;font-size:10px;color:var(--txt2);text-transform:uppercase;letter-spacing:.12em;font-weight:500;margin-bottom:6px;font-family:'IBM Plex Mono',monospace;}
.ff input{width:100%;padding:13px 14px;background:var(--p2);border:1px solid var(--p4);border-radius:10px;color:var(--txt);font-size:16px;outline:none;transition:.2s;font-family:inherit;}
.ff input:focus{border-color:var(--red-bdr);background:var(--p1);box-shadow:0 0 0 3px rgba(229,57,53,.07);}
.auth-btn{width:100%;padding:14px;background:var(--red);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:.18s;font-family:inherit;letter-spacing:.02em;box-shadow:0 4px 24px rgba(229,57,53,.3);}
.auth-btn:active{background:var(--red-d);transform:scale(.98);}
.auth-sw{text-align:center;margin-top:16px;color:var(--txt2);font-size:14px;}
.auth-sw a{color:var(--red-l);cursor:pointer;}
.alrt{padding:10px 12px;border-radius:8px;font-size:13px;margin-bottom:12px;display:none;animation:fadeIn .2s;}
.alrt.err{background:rgba(229,57,53,.08);border:1px solid rgba(229,57,53,.25);color:#ef9a9a;}
.alrt.ok{background:rgba(67,160,71,.07);border:1px solid rgba(67,160,71,.2);color:#a5d6a7;}

/* ‚îÄ‚îÄ APP LAYOUT ‚îÄ‚îÄ */
#app{display:none;width:100%;height:100%;flex-direction:column;overflow:hidden;position:relative;z-index:1;}
#app.on{display:flex;}
#viewList{display:flex;flex-direction:column;width:100%;height:100%;flex:1;min-height:0;}
#viewChat{display:none;flex-direction:column;width:100%;height:100%;flex:1;min-height:0;}
#viewChat.on{display:flex;}

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
.topbar{flex-shrink:0;padding:0 12px;padding-top:var(--sat);height:calc(56px + var(--sat));background:var(--p1);display:flex;align-items:flex-end;gap:10px;padding-bottom:8px;border-bottom:1px solid var(--p3);position:relative;z-index:100;backdrop-filter:blur(10px);}
.tb-title{flex:1;font-family:'IBM Plex Mono',monospace;font-size:16px;font-weight:600;letter-spacing:.06em;}
.online-count{font-size:10px;color:var(--green);font-family:'IBM Plex Mono',monospace;display:flex;align-items:center;gap:4px;}
.online-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s ease-in-out infinite;box-shadow:0 0 6px var(--green);}
@keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.3);}}
.tb-ico{width:36px;height:36px;border-radius:9px;border:none;background:transparent;color:var(--txt2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:.15s;flex-shrink:0;}
.tb-ico:active{background:var(--p3);color:var(--txt);}
.tb-ava{width:34px;height:34px;border-radius:50%;object-fit:cover;cursor:pointer;border:2px solid var(--p4);transition:.2s;}
.tb-ava:active{transform:scale(.95);}

/* ‚îÄ‚îÄ CONTACT LIST ‚îÄ‚îÄ */
.cl{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;min-height:0;}
.cl::-webkit-scrollbar{display:none;}
.sw-wrap{padding:8px 12px;background:var(--p1);border-bottom:1px solid var(--p3);}
.si{width:100%;padding:9px 14px 9px 36px;background:var(--p3);border:1px solid var(--p4);border-radius:20px;color:var(--txt);font-size:15px;outline:none;font-family:inherit;transition:.2s;}
.si:focus{border-color:var(--p5);background:var(--p2);}
.si-wrap{position:relative;}
.si-ic{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--txt3);font-size:13px;pointer-events:none;}
.ci{display:flex;align-items:center;gap:12px;padding:12px 16px;cursor:pointer;position:relative;border-bottom:1px solid rgba(255,255,255,.02);transition:.15s;-webkit-user-select:none;user-select:none;animation:msgIn .3s ease-out;}
@keyframes msgIn{from{opacity:0;transform:translateX(-10px);}to{opacity:1;transform:translateX(0);}}
.ci:active{background:var(--p2);}
.caw{position:relative;flex-shrink:0;}
.ca{width:50px;height:50px;border-radius:50%;object-fit:cover;background:var(--p3);}
.cod{position:absolute;bottom:2px;right:2px;width:12px;height:12px;border-radius:50%;background:var(--green);border:2px solid var(--p1);box-shadow:0 0 6px var(--green);}
.cb{flex:1;min-width:0;}
.ct{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:3px;}
.cn{font-size:15px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.ctm{font-size:11px;color:var(--txt3);flex-shrink:0;margin-left:6px;}
.cbo{display:flex;justify-content:space-between;align-items:center;}
.clm{font-size:13px;color:var(--txt2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.ubadge{background:var(--red);color:#fff;border-radius:10px;padding:2px 7px;font-size:11px;font-weight:600;flex-shrink:0;margin-left:6px;animation:badgePop .2s ease-out;}
@keyframes badgePop{from{transform:scale(0);}to{transform:scale(1);}}
.nc{padding:40px 20px;text-align:center;color:var(--txt3);font-size:14px;line-height:1.8;}

/* ‚îÄ‚îÄ CHAT TOPBAR ‚îÄ‚îÄ */
.chat-topbar{flex-shrink:0;padding:0 8px;padding-top:var(--sat);height:calc(60px + var(--sat));background:var(--p1);display:flex;align-items:flex-end;gap:8px;padding-bottom:10px;border-bottom:1px solid var(--p3);backdrop-filter:blur(10px);}
.chat-ava{width:40px;height:40px;border-radius:50%;object-fit:cover;cursor:pointer;border:2px solid transparent;transition:.2s;}
.chat-ava.online{border-color:var(--green);box-shadow:0 0 10px rgba(67,160,71,.4);}
.chat-info{flex:1;min-width:0;}
.chat-name{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.chat-st{font-size:12px;color:var(--txt2);}
.chat-acts{display:flex;gap:2px;}

/* ‚îÄ‚îÄ MESSAGES AREA ‚îÄ‚îÄ */
.ma{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:12px 10px;display:flex;flex-direction:column;gap:2px;min-height:0;}
.ma::-webkit-scrollbar{display:none;}
.dd{text-align:center;margin:12px 0;}
.dd span{background:var(--p2);padding:4px 12px;border-radius:12px;font-size:11px;color:var(--txt3);font-family:'IBM Plex Mono',monospace;}
.mw{display:flex;flex-direction:column;max-width:80%;position:relative;animation:msgSlide .2s ease-out;}
@keyframes msgSlide{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.mw.out{align-self:flex-end;align-items:flex-end;}
.mw.in{align-self:flex-start;align-items:flex-start;}
.mb{padding:10px 14px;border-radius:var(--msg-radius);font-size:15px;line-height:1.5;word-break:break-word;position:relative;}
.mw.out .mb{background:linear-gradient(135deg,#200808,#1a0505);border-radius:var(--msg-radius) var(--msg-radius) 4px var(--msg-radius);}
.mw.in .mb{background:var(--p2);border-radius:var(--msg-radius) var(--msg-radius) var(--msg-radius) 4px;}
.mb:active{opacity:.85;}
.mm{font-size:11px;color:var(--txt3);margin-top:4px;display:flex;align-items:center;gap:4px;font-family:'IBM Plex Mono',monospace;}
.ri{color:var(--txt3);}
.ri.r{color:var(--red);}
.msg-img{max-width:220px;max-height:260px;border-radius:12px;display:block;cursor:pointer;transition:.2s;}
.msg-img:active{transform:scale(.97);}
.mb-quote{border-left:2px solid var(--red);padding:6px 10px;margin-bottom:8px;border-radius:0 8px 8px 0;background:var(--red-dim);}
.qn{font-size:11px;color:var(--red-l);font-weight:600;margin-bottom:2px;font-family:'IBM Plex Mono',monospace;}
.qtext{font-size:13px;color:var(--txt2);}
/* reactions */
.react-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:7px;padding:2px 0;}
.rpill{padding:5px 11px 5px 8px;background:var(--p2);border-radius:20px;font-size:17px;cursor:pointer;border:1.5px solid var(--p4);display:flex;align-items:center;gap:5px;transition:.15s;min-height:32px;box-shadow:0 2px 8px rgba(0,0,0,.35);user-select:none;}
.rpill:active{transform:scale(1.2);}
.rpill:hover{border-color:var(--red-l);background:var(--p3);}
.rpill.mine{border-color:var(--red-bdr);background:rgba(176,0,32,.18);box-shadow:0 0 10px rgba(176,0,32,.35);}
.rc{font-size:12px;font-weight:700;color:var(--txt);font-family:'IBM Plex Mono',monospace;line-height:1;}
/* quick reactions */
.qact{display:flex;gap:4px;margin-bottom:5px;flex-wrap:wrap;background:var(--p1);border:1px solid var(--p3);border-radius:20px;padding:5px 8px;box-shadow:0 4px 16px rgba(0,0,0,.5);}
.qab{width:32px;height:32px;border:none;background:none;border-radius:50%;font-size:18px;cursor:pointer;transition:.15s;display:flex;align-items:center;justify-content:center;}
.qab:active{transform:scale(1.3);}
/* pinned */
#pinnedBar{display:none;flex-shrink:0;padding:8px 14px;background:rgba(229,57,53,.06);border-bottom:1px solid var(--red-bdr);cursor:pointer;flex-direction:row;align-items:center;gap:10px;transition:.2s;}
#pinnedBar.on{display:flex;}
.pin-line{width:3px;height:36px;background:var(--red);border-radius:2px;box-shadow:0 0 6px var(--red-glow);}
.pin-info{flex:1;min-width:0;}
.pin-label{font-size:9px;color:var(--red);font-family:'IBM Plex Mono',monospace;letter-spacing:.1em;font-weight:700;}
.pin-text{font-size:13px;color:var(--txt2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
/* typing */
.twrap{display:none;padding:6px 14px;font-size:12px;color:var(--txt2);align-items:center;gap:6px;flex-shrink:0;}
.twrap.on{display:flex;}
.tdot{width:6px;height:6px;border-radius:50%;background:var(--txt3);animation:tdot .9s ease-in-out infinite;}
.tdot:nth-child(2){animation-delay:.15s;}
.tdot:nth-child(3){animation-delay:.3s;}
@keyframes tdot{0%,80%,100%{transform:scale(.7);}40%{transform:scale(1.2);}}
/* reply bar */
#replyBar{display:none;flex-shrink:0;padding:10px 14px;background:var(--p1);border-top:1px solid var(--p3);}
#replyBar.on{display:block;}
.reply-inner{display:flex;align-items:center;gap:10px;}
.ri-txt{flex:1;min-width:0;}
.ri-who{font-size:11px;color:var(--red-l);font-weight:600;margin-bottom:2px;font-family:'IBM Plex Mono',monospace;}
.ri-prev{font-size:13px;color:var(--txt2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ri-x{background:none;border:none;color:var(--txt3);cursor:pointer;font-size:20px;padding:4px;}
/* forward bar */
#fwdBar{display:none;flex-shrink:0;padding:10px 14px;background:rgba(240,180,41,.05);border-top:1px solid var(--gold-bdr);}
#fwdBar.on{display:block;}

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
.ia-wrap{flex-shrink:0;background:var(--p1);border-top:1px solid var(--p3);padding:8px 10px;padding-bottom:calc(8px + var(--sab));}
.ia{display:flex;align-items:flex-end;gap:6px;}
/* Format bar */
#fmtBar{display:none;flex-shrink:0;padding:6px 12px;background:var(--p1);border-top:1px solid var(--p3);gap:4px;flex-wrap:wrap;}
#fmtBar.on{display:flex;}
.fmt-btn{padding:5px 10px;background:var(--p3);border:1px solid var(--p4);border-radius:8px;color:var(--txt2);font-size:13px;cursor:pointer;transition:.15s;}
.fmt-btn:active{background:var(--red-dim);border-color:var(--red-bdr);color:var(--red-l);}
.abtn{width:38px;height:38px;border-radius:50%;border:none;background:transparent;color:var(--txt2);cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:.15s;flex-shrink:0;}
.abtn:active{color:var(--txt);background:var(--p3);}
.mi2{flex:1;padding:10px 14px;background:var(--p2);border:1px solid var(--p4);border-radius:22px;color:var(--txt);font-size:15px;resize:none;max-height:100px;outline:none;font-family:inherit;line-height:1.45;transition:.2s;}
.mi2:focus{border-color:var(--p5);background:var(--p1);}
.mi2::placeholder{color:var(--txt3);}
.sbtn{width:42px;height:42px;border-radius:50%;flex-shrink:0;background:var(--red);border:none;color:#fff;cursor:pointer;font-size:17px;display:flex;align-items:center;justify-content:center;transition:.2s;box-shadow:0 3px 14px rgba(229,57,53,.35);}
.sbtn:active{transform:scale(.9);}

/* voice rec */
#voiceRec{display:none;align-items:center;gap:10px;}
#voiceRec.on{display:flex;}
.vrec-wave{flex:1;display:flex;align-items:center;gap:3px;height:32px;}
.vrec-bar{width:3px;background:var(--red);border-radius:2px;animation:vwave 1.2s ease-in-out infinite;box-shadow:0 0 4px var(--red-glow);}
.vrec-bar:nth-child(2){animation-delay:.15s;}
.vrec-bar:nth-child(3){animation-delay:.3s;}
.vrec-bar:nth-child(4){animation-delay:.45s;}
.vrec-bar:nth-child(5){animation-delay:.6s;}
@keyframes vwave{0%,100%{height:6px;}50%{height:24px;}}
.vrec-time{font-size:14px;color:var(--txt2);font-family:'IBM Plex Mono',monospace;min-width:44px;}
.vrec-btn{width:40px;height:40px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:.15s;flex-shrink:0;}
.vrec-cancel{background:var(--p3);color:var(--txt3);}
.vrec-send{background:var(--red);color:#fff;box-shadow:0 3px 12px rgba(229,57,53,.3);}

/* voice player */
.vplayer{display:flex;align-items:center;gap:8px;min-width:160px;}
.vpl-btn{width:36px;height:36px;border-radius:50%;border:none;background:var(--red);color:#fff;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.vpl-prog{flex:1;height:4px;background:var(--p4);border-radius:2px;cursor:pointer;position:relative;min-width:80px;}
.vpl-fill{height:100%;background:var(--red);border-radius:2px;width:0%;transition:.1s;}
.vpl-dur{font-size:11px;color:var(--txt2);font-family:'IBM Plex Mono',monospace;flex-shrink:0;}

/* sticker */
.msg-sticker{font-size:64px;line-height:1;display:block;animation:stickerPop .3s cubic-bezier(.17,.67,.35,1.5);}
@keyframes stickerPop{from{transform:scale(0);}to{transform:scale(1);}}

/* code formatting */
.msg-code{background:var(--p3);border:1px solid var(--p4);border-radius:6px;padding:2px 7px;font-family:'IBM Plex Mono',monospace;font-size:13px;color:#a5d6a7;}
.msg-code-block{background:var(--p3);border:1px solid var(--p4);border-radius:8px;padding:10px 12px;font-family:'IBM Plex Mono',monospace;font-size:12px;white-space:pre-wrap;overflow-x:auto;max-width:100%;margin:4px 0;}
.msg-bold{font-weight:700;}
.msg-italic{font-style:italic;}
.msg-strike{text-decoration:line-through;opacity:.7;}

/* scroll btn */
#scrollBtn{position:absolute;bottom:80px;right:14px;width:38px;height:38px;border-radius:50%;background:var(--p1);border:1px solid var(--p4);color:var(--txt2);cursor:pointer;font-size:15px;display:none;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,.6);z-index:50;transition:.2s;}
#scrollBtn.on{display:flex;}
.sbu{position:absolute;top:-6px;right:-4px;background:var(--red);color:#fff;border-radius:10px;padding:1px 5px;font-size:9px;font-weight:600;display:none;font-family:'IBM Plex Mono',monospace;}

/* ‚îÄ‚îÄ BOTTOM SHEET ‚îÄ‚îÄ */
.bsheet{position:fixed;inset:0;z-index:8000;display:none;align-items:flex-end;}
.bsheet.on{display:flex;}
.bs-ov{position:absolute;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(2px);}
.bs-body{position:relative;width:100%;background:var(--p1);border-radius:20px 20px 0 0;padding:16px 0 calc(16px + var(--sab));max-height:85vh;overflow-y:auto;animation:bsup .25s cubic-bezier(.2,.8,.3,1);}
@keyframes bsup{from{transform:translateY(100%);}to{transform:translateY(0);}}
.bs-handle{width:40px;height:4px;background:var(--p4);border-radius:2px;margin:0 auto 16px;}
.bs-hdr{font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--txt3);padding:0 18px 10px;letter-spacing:.08em;}
.bs-item{display:flex;align-items:center;gap:14px;padding:14px 20px;cursor:pointer;transition:.1s;font-size:16px;}
.bs-item:active{background:var(--p2);}
.bs-ic{width:24px;text-align:center;font-size:20px;flex-shrink:0;}
.bs-div{height:1px;background:var(--p3);margin:5px 0;}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9000;display:none;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(4px);}
.mo.on{display:flex;}
.mc{background:var(--p1);border:1px solid var(--p3);border-radius:16px;padding:22px;width:100%;max-width:380px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 60px rgba(0,0,0,.9);animation:mopi .2s ease-out;}
@keyframes mopi{from{opacity:0;transform:scale(.92);}to{opacity:1;transform:scale(1);}}
.mc-t{font-size:18px;font-weight:700;margin-bottom:4px;}
.mc-s{font-size:14px;color:var(--txt3);margin-bottom:14px;}
.mac{display:flex;gap:8px;margin-top:14px;}
.mbtn{flex:1;padding:13px;border-radius:10px;border:none;font-size:15px;font-weight:600;cursor:pointer;transition:.15s;font-family:inherit;}
.mbtn.sec{background:var(--p3);color:var(--txt);border:1px solid var(--p4);}
.mbtn.dng{background:rgba(229,57,53,.1);color:#ef9a9a;border:1px solid rgba(229,57,53,.22);}
.mbtn.prim{background:var(--red);color:#fff;}
.mbtn:active{transform:scale(.97);}
.pma{width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--p4);display:block;margin:0 auto 14px;}
.pir{display:flex;justify-content:space-between;padding:11px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:14px;}
.pil{color:var(--txt3);font-family:'IBM Plex Mono',monospace;font-size:12px;}
.tgl{position:relative;width:44px;height:26px;flex-shrink:0;}
.tgl input{opacity:0;width:0;height:0;}
.tgl-t{position:absolute;inset:0;background:var(--p4);border-radius:13px;cursor:pointer;transition:.2s;}
.tgl input:checked + .tgl-t{background:var(--red);}
.tgl-th{position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;transition:.2s;pointer-events:none;}
.tgl input:checked ~ .tgl-th{left:21px;}
.sg{margin-bottom:18px;}
.sg-t{font-size:10px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.18em;margin-bottom:8px;font-family:'IBM Plex Mono',monospace;}
.sr{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.03);}
.sl{font-size:14px;}
.ss{font-size:12px;color:var(--txt3);margin-top:2px;}

/* Hard+ */
.hp-badge{display:inline-flex;align-items:center;background:linear-gradient(135deg,#b8860b,#f0b429,#b8860b);color:#0a0a0a;font-size:9px;font-weight:700;padding:2px 7px;border-radius:8px;font-family:'IBM Plex Mono',monospace;letter-spacing:.08em;text-transform:uppercase;box-shadow:0 2px 10px var(--gold-glow);}
.hplus-hero{background:linear-gradient(135deg,rgba(240,180,41,.1),rgba(240,180,41,.04));border:1px solid var(--gold-bdr);border-radius:12px;padding:16px;margin-bottom:16px;position:relative;overflow:hidden;}
.hplus-hero::before{content:'‚òÖ';position:absolute;right:14px;top:10px;font-size:50px;opacity:.06;color:var(--gold);}
.hplus-hero-title{font-size:17px;font-weight:700;color:var(--gold);font-family:'IBM Plex Mono',monospace;margin-bottom:4px;}
.hplus-hero-sub{font-size:12px;color:var(--txt2);}
.hp-promo-inp{width:100%;padding:12px 14px;background:var(--p2);border:1px solid var(--p4);border-radius:10px;color:var(--txt);font-size:16px;outline:none;font-family:'IBM Plex Mono',monospace;margin:10px 0;transition:.2s;}
.hp-promo-inp:focus{border-color:var(--gold-bdr);}
.hp-promo-btn{width:100%;padding:13px;background:var(--gold);color:#0a0a0a;border:none;border-radius:10px;font-weight:700;font-size:16px;cursor:pointer;font-family:inherit;transition:.2s;}
.hp-promo-btn:active{transform:scale(.98);}
.theme-btn{padding:8px 14px;border-radius:9px;border:1px solid var(--p4);background:var(--p3);color:var(--txt2);font-size:13px;cursor:pointer;transition:.15s;}
.theme-btn.on{border-color:var(--gold-bdr);color:var(--gold);background:var(--gold-dim);}
.user-title{font-size:11px;padding:1px 6px;border-radius:6px;font-weight:700;font-family:'IBM Plex Mono',monospace;letter-spacing:.04em;margin-left:4px;display:inline-block;vertical-align:middle;}
.sd-timer{font-size:11px;color:var(--red-l);font-family:'IBM Plex Mono',monospace;margin-top:4px;display:flex;align-items:center;gap:5px;}
.sd-timer::before{content:'üí£';font-size:12px;}

/* GIF */
.gif-search{width:100%;padding:11px 14px;background:var(--p2);border:1px solid var(--p4);border-radius:10px;color:var(--txt);font-size:16px;outline:none;font-family:inherit;margin-bottom:10px;transition:.2s;}
.gif-search:focus{border-color:var(--red-bdr);}
#gifGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;max-height:280px;overflow-y:auto;}
#gifGrid img{width:100%;height:90px;object-fit:cover;border-radius:8px;cursor:pointer;transition:.15s;}
#gifGrid img:active{transform:scale(.95);}

/* sticker grid */
#stkGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;max-height:240px;overflow-y:auto;}

/* CTX MENU */
.cxbs{position:fixed;inset:0;z-index:9999;display:none;align-items:flex-end;}
.cxbs.on{display:flex;}
.cxbs-ov{position:absolute;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(2px);}
.cxbs-body{position:relative;width:100%;background:var(--p1);border-radius:20px 20px 0 0;padding:8px 0 calc(16px + var(--sab));animation:bsup .2s ease-out;}
.cxi{display:flex;align-items:center;gap:14px;padding:14px 22px;cursor:pointer;font-size:16px;color:var(--txt2);}
.cxi:active{background:var(--p2);}
.cxi.dng{color:#ef9a9a;}
.cx-div{height:1px;background:var(--p3);margin:4px 0;}

/* Toast */
#tc{position:fixed;top:calc(var(--sat) + 62px);left:50%;transform:translateX(-50%);z-index:99999;display:flex;flex-direction:column;gap:7px;align-items:center;width:90%;max-width:340px;}
.toast{background:var(--p1);color:var(--txt);padding:12px 18px;border-radius:12px;font-size:14px;box-shadow:0 8px 24px rgba(0,0,0,.6);border-left:3px solid var(--red);animation:tin .22s ease-out;width:100%;text-align:center;backdrop-filter:blur(10px);}
.toast.ok{border-left-color:var(--green);}
.toast.info{border-left-color:var(--gold);}
@keyframes tin{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:translateY(0);}}

/* img preview */
.ipov{position:fixed;inset:0;background:rgba(0,0,0,.97);z-index:9999;display:none;align-items:center;justify-content:center;flex-direction:column;}
.ipov.on{display:flex;}
.ipov img{max-width:96vw;max-height:80vh;border-radius:10px;object-fit:contain;}
.ipcl{position:absolute;top:calc(var(--sat) + 14px);right:18px;font-size:28px;color:#555;cursor:pointer;padding:8px;}
.ipdown{position:absolute;bottom:calc(var(--sab) + 20px);background:var(--p2);border:1px solid var(--p4);color:var(--txt2);border-radius:10px;padding:10px 20px;cursor:pointer;font-size:14px;border:none;}

/* stats */
.stats-row{display:flex;gap:10px;margin-top:12px;}
.stat-card{text-align:center;flex:1;padding:14px;background:var(--p2);border-radius:12px;border:1px solid var(--p3);}
.stat-num{font-family:'IBM Plex Mono',monospace;font-size:24px;font-weight:700;color:var(--red);display:block;}
.stat-lbl{font-size:11px;color:var(--txt3);}


/* ‚îÄ‚îÄ @MENTIONS ‚îÄ‚îÄ */
.mention{color:#82b1ff;font-weight:600;background:rgba(130,177,255,.12);border-radius:4px;padding:1px 4px;}
.mention-me{color:#ffd740;font-weight:700;background:rgba(255,215,64,.15);border-radius:4px;padding:1px 4px;animation:mentPulse .6s ease-out;}
@keyframes mentPulse{0%{box-shadow:0 0 0 0 rgba(255,215,64,.5);}100%{box-shadow:0 0 0 8px transparent;}}

/* ‚îÄ‚îÄ /DICE COMMAND ‚îÄ‚îÄ */
.dice-face{font-size:44px;display:block;text-align:center;animation:diceIn .35s cubic-bezier(.175,.885,.32,1.5);}
@keyframes diceIn{0%{transform:rotate(-180deg) scale(0);opacity:0;}100%{transform:rotate(0deg) scale(1);opacity:1;}}
.dice-val{font-size:11px;color:var(--txt3);font-family:'IBM Plex Mono',monospace;text-align:center;display:block;margin-top:2px;}

/* ‚îÄ‚îÄ EDIT MESSAGE ‚îÄ‚îÄ */
.edit-bar{display:none;padding:7px 12px;background:var(--p1);border-top:1px solid var(--p3);font-size:12px;color:var(--txt2);gap:8px;align-items:center;}
.edit-bar.on{display:flex;}
.edit-tag{flex:1;color:var(--red-l);font-style:italic;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.edit-cancel{padding:4px 10px;border:1px solid var(--p4);border-radius:10px;cursor:pointer;background:var(--p2);color:var(--txt2);font-size:11px;}

/* ‚îÄ‚îÄ JUMP TO TOP BTN ‚îÄ‚îÄ */
#jumpTopBtn{position:absolute;top:10px;right:14px;width:38px;height:38px;border-radius:50%;background:var(--p2);border:1px solid var(--p4);color:var(--txt2);display:none;align-items:center;justify-content:center;cursor:pointer;font-size:14px;box-shadow:0 4px 14px rgba(0,0,0,.6);z-index:40;transition:.2s;}
#jumpTopBtn.on{display:flex;}
#jumpTopBtn:active{transform:scale(.9);}

/* ‚îÄ‚îÄ TEMPLATES BAR ‚îÄ‚îÄ */
#tplBar{display:none;padding:8px 10px;gap:7px;overflow-x:auto;-webkit-overflow-scrolling:touch;background:var(--p1);border-top:1px solid var(--p3);flex-shrink:0;scrollbar-width:none;}
#tplBar::-webkit-scrollbar{display:none;}
#tplBar.on{display:flex;}
.tpl{padding:7px 13px;background:var(--p2);border:1px solid var(--p4);border-radius:16px;color:var(--txt2);font-size:13px;white-space:nowrap;cursor:pointer;flex-shrink:0;transition:.15s;}
.tpl:active{background:var(--red-dim);border-color:var(--red-bdr);color:var(--txt);}

/* ‚îÄ‚îÄ UNREAD BADGE in topbar ‚îÄ‚îÄ */
#unreadBadge{background:var(--red);color:#fff;border-radius:9px;padding:1px 6px;font-size:10px;font-weight:700;font-family:'IBM Plex Mono',monospace;display:none;margin-left:4px;vertical-align:middle;}

/* ‚îÄ‚îÄ DOUBLE-TAP HEART ‚îÄ‚îÄ */
@keyframes floatHeart{0%{transform:scale(0) translateY(0);opacity:1;}70%{transform:scale(1.4) translateY(-30px);opacity:.9;}100%{transform:scale(1.6) translateY(-60px);opacity:0;}}
.float-heart{position:fixed;pointer-events:none;font-size:30px;z-index:9999;animation:floatHeart .6s ease-out forwards;}

/* ‚îÄ‚îÄ MESSAGE CONTEXT MENU reaction row ‚îÄ‚îÄ */
#cxbs .cxreact{display:flex;gap:5px;padding:10px 12px;border-bottom:1px solid var(--p3);}
#cxbs .cxreact span{font-size:24px;cursor:pointer;transition:.15s;line-height:1;}
#cxbs .cxreact span:active{transform:scale(1.4);}


/* ‚îÄ‚îÄ SEARCH MODE ‚îÄ‚îÄ */
#si{transition:.2s;}
#si.search-mode{border-color:var(--red-bdr);background:rgba(176,0,32,.06);}
#newChatBtn{display:flex;align-items:center;justify-content:center;gap:8px;width:56px;height:56px;border-radius:50%;background:var(--red);color:#fff;font-size:24px;border:none;cursor:pointer;position:fixed;bottom:calc(20px + var(--sab));right:18px;z-index:200;box-shadow:0 4px 20px rgba(176,0,32,.55);transition:.2s;animation:fabIn .3s cubic-bezier(.175,.885,.32,1.5);}
@keyframes fabIn{0%{transform:scale(0) rotate(-180deg);}100%{transform:scale(1) rotate(0deg);}}
#newChatBtn:active{transform:scale(.9);}

/* ‚îÄ‚îÄ CONTACT LIST EMPTY/SEARCH states ‚îÄ‚îÄ */
.nc-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:48px 20px;color:var(--txt3);}
.nc-empty .nc-ic{font-size:52px;opacity:.4;}
.nc-empty .nc-t{font-size:16px;font-weight:600;color:var(--txt2);}
.nc-empty .nc-s{font-size:13px;text-align:center;line-height:1.5;}
.nc-empty .nc-btn{padding:11px 22px;background:var(--red);color:#fff;border:none;border-radius:14px;cursor:pointer;font-size:14px;font-weight:600;transition:.15s;}
.nc-empty .nc-btn:active{transform:scale(.96);}

/* ‚îÄ‚îÄ SEARCH RESULT ITEM (find new user) ‚îÄ‚îÄ */
.ci.search-result{border-left:2px solid var(--red-bdr);}
.ci.search-result .cn::after{content:' ¬∑ –Ω–∞–π—Ç–∏';font-size:11px;color:var(--red-l);font-weight:400;}

/* ‚îÄ‚îÄ SECTION DIVIDER ‚îÄ‚îÄ */
.cl-section{font-size:10px;font-weight:700;letter-spacing:.08em;color:var(--txt3);padding:10px 16px 4px;text-transform:uppercase;font-family:'IBM Plex Mono',monospace;}

/* ‚îÄ‚îÄ STARRED CONTACTS ‚îÄ‚îÄ */
.ci.starred{background:rgba(240,180,41,.03);}
.star-btn{background:none;border:none;font-size:16px;cursor:pointer;padding:4px 6px;opacity:.5;transition:.15s;flex-shrink:0;}
.star-btn.on{opacity:1;}
.star-badge{font-size:11px;position:absolute;top:6px;right:8px;opacity:.7;}

/* ‚îÄ‚îÄ DRAFT ‚îÄ‚îÄ */
.draft-pfx{color:var(--red-l);font-size:12px;font-weight:600;font-family:'IBM Plex Mono',monospace;margin-right:3px;}

/* ‚îÄ‚îÄ SEARCH HINT ‚îÄ‚îÄ */
.search-hint{font-size:11px;color:var(--txt3);padding:4px 16px 6px;font-family:'IBM Plex Mono',monospace;border-bottom:1px solid rgba(255,255,255,.03);}

/* ‚îÄ‚îÄ PINNED CONTACTS TOP ‚îÄ‚îÄ */
.ci.pinned-contact{border-left:2px solid var(--gold-bdr);}

/* ‚îÄ‚îÄ READ RECEIPT TICKS ‚îÄ‚îÄ */
.tick{font-size:11px;margin-left:3px;display:inline;}
.tick.sent{color:var(--txt3);}
.tick.read{color:#64b5f6;}

/* ‚îÄ‚îÄ MEDIA GALLERY ‚îÄ‚îÄ */
.gallery-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;padding:3px;}
.gal-img{width:100%;aspect-ratio:1;object-fit:cover;cursor:pointer;border-radius:4px;transition:.15s;}
.gal-img:active{opacity:.7;}
.gallery-empty{padding:20px;text-align:center;color:var(--txt3);font-size:13px;}

/* ‚îÄ‚îÄ STATUS STORIES ring ‚îÄ‚îÄ */
.ca.has-story{border:2px solid var(--red);box-shadow:0 0 0 2px rgba(176,0,32,.35);}

/* ‚îÄ‚îÄ MUTE ICON ‚îÄ‚îÄ */
.muted-ic{font-size:12px;color:var(--txt3);margin-left:2px;}

/* ‚îÄ‚îÄ CLEAR SEARCH ‚îÄ‚îÄ */
#siClear{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--txt3);font-size:18px;cursor:pointer;display:none;padding:4px;}
#siClear.on{display:block;}

/* themes */
body.theme-glitch{--bg:#0d0005;--p1:#12000a;--p2:#160008;--p3:#1e000e;--p4:#280012;}
body.theme-cyber{--bg:#000d0d;--p1:#001212;--p2:#001616;--p3:#001c1c;--p4:#002424;--red:#00e5cc;--red-d:#00b3a0;--red-l:#33ffe8;--red-glow:rgba(0,229,204,.3);--red-dim:rgba(0,229,204,.07);--red-bdr:rgba(0,229,204,.2);}
body.theme-purple{--bg:#08000f;--p1:#0d0015;--p2:#12001c;--p3:#180024;--p4:#20002e;--red:#9c27b0;--red-d:#6a0080;--red-l:#ba68c8;--red-glow:rgba(156,39,176,.3);--red-dim:rgba(156,39,176,.08);--red-bdr:rgba(156,39,176,.25);}
body.theme-gold{--bg:#080600;--p1:#0e0c00;--p2:#141000;--p3:#1c1600;--p4:#241e00;--red:#f0b429;--red-d:#b8860b;--red-l:#f5c842;--red-glow:rgba(240,180,41,.3);--red-dim:rgba(240,180,41,.08);--red-bdr:rgba(240,180,41,.25);}
body.theme-ocean{--bg:#000810;--p1:#001020;--p2:#001428;--p3:#001c34;--p4:#002444;--red:#1e88e5;--red-d:#1565c0;--red-l:#42a5f5;--red-glow:rgba(30,136,229,.3);--red-dim:rgba(30,136,229,.08);--red-bdr:rgba(30,136,229,.25);}
body.theme-forest{--bg:#010a04;--p1:#021208;--p2:#031a0c;--p3:#042412;--p4:#062e18;--red:#2e7d32;--red-d:#1b5e20;--red-l:#43a047;--red-glow:rgba(46,125,50,.3);--red-dim:rgba(46,125,50,.08);--red-bdr:rgba(46,125,50,.25);}

/* emoji picker */
#emojiPicker{display:none;position:absolute;bottom:56px;left:10px;right:10px;background:var(--p1);border:1px solid var(--p3);border-radius:16px;padding:10px;z-index:1000;box-shadow:0 -8px 30px rgba(0,0,0,.6);}
#emojiPicker.on{display:block;animation:bsup .2s ease-out;}
.emoji-cats{display:flex;gap:6px;margin-bottom:8px;overflow-x:auto;}
.emoji-cat{padding:4px 10px;background:var(--p3);border:1px solid var(--p4);border-radius:10px;font-size:14px;cursor:pointer;white-space:nowrap;transition:.15s;}
.emoji-cat.on{background:var(--red-dim);border-color:var(--red-bdr);}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;max-height:140px;overflow-y:auto;}
.emoji-btn{font-size:22px;background:none;border:none;cursor:pointer;border-radius:8px;padding:4px;transition:.15s;}
.emoji-btn:active{transform:scale(1.3);background:var(--p3);}

/* bookmarks */
.bk-item{padding:10px 0;border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer;}
.bk-time{font-size:10px;color:var(--txt3);font-family:'IBM Plex Mono',monospace;}
.bk-txt{font-size:13px;color:var(--txt2);margin-top:2px;}

/* music share */
.music-card{background:linear-gradient(135deg,var(--p2),var(--p3));border:1px solid var(--p4);border-radius:12px;padding:12px;display:flex;align-items:center;gap:10px;}
.music-icon{font-size:32px;}
.music-info{flex:1;}
.music-title{font-size:14px;font-weight:600;}
.music-artist{font-size:12px;color:var(--txt2);}
/* ‚ïê‚ïê GROUP / CHANNEL BADGES ‚ïê‚ïê */
.ci-type{font-size:9px;padding:1px 5px;border-radius:4px;font-family:'IBM Plex Mono',monospace;font-weight:700;letter-spacing:.04em;flex-shrink:0;margin-left:3px;}
.ci-type.grp{background:rgba(30,136,229,.15);color:#42a5f5;border:1px solid rgba(30,136,229,.3);}
.ci-type.chn{background:rgba(156,39,176,.15);color:#ba68c8;border:1px solid rgba(156,39,176,.3);}
.ca.grp-ava{border-radius:10px;}
.ca.chn-ava{border-radius:4px;}

/* ‚ïê‚ïê CREATE GROUP/CHANNEL MODAL ‚ïê‚ïê */
#gcMo .mc{max-width:420px;}
.gc-member-list{max-height:220px;overflow-y:auto;margin:8px 0;}
.gc-member{display:flex;align-items:center;gap:9px;padding:7px 2px;border-bottom:1px solid rgba(255,255,255,.03);cursor:pointer;border-radius:6px;transition:.1s;}
.gc-member:hover{background:var(--p2);}
.gc-member input[type=checkbox]{width:16px;height:16px;accent-color:var(--red);flex-shrink:0;cursor:pointer;}
.gc-member img{width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0;}
.gc-member .gm-name{font-size:13px;flex:1;}
.gc-inp{width:100%;padding:9px 12px;background:var(--p2);border:1px solid var(--p4);border-radius:8px;color:var(--txt);font-size:14px;outline:none;font-family:inherit;margin-bottom:10px;transition:.15s;}
.gc-inp:focus{border-color:var(--red-bdr);}
.gc-type-tabs{display:flex;gap:6px;margin-bottom:12px;}
.gc-tab{flex:1;padding:8px;border-radius:8px;border:1px solid var(--p4);background:var(--p3);color:var(--txt2);cursor:pointer;font-size:13px;font-weight:500;transition:.12s;text-align:center;}
.gc-tab.on{background:var(--red);border-color:var(--red);color:#fff;}

/* ‚ïê‚ïê MEMBER LIST IN CHAT HEADER ‚ïê‚ïê */
.ch-members{font-size:11px;color:var(--txt2);}
.ch-members span{color:var(--green);}

/* ‚ïê‚ïê GROUP INFO PANEL ‚ïê‚ïê */
#grpInfoMo .mc{max-width:400px;}
.grp-members-list{max-height:260px;overflow-y:auto;margin:8px 0;}
.grp-member-row{display:flex;align-items:center;gap:9px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.03);}
.grp-member-row img{width:34px;height:34px;border-radius:50%;object-fit:cover;}
.grp-member-role{font-size:10px;color:var(--red-l);font-family:'IBM Plex Mono',monospace;margin-left:auto;flex-shrink:0;}
.grp-kick-btn{background:none;border:none;color:var(--txt3);cursor:pointer;font-size:13px;padding:3px 6px;border-radius:4px;transition:.1s;flex-shrink:0;}
.grp-kick-btn:hover{color:#ef5350;background:rgba(229,57,53,.08);}

/* ‚ïê‚ïê CHANNEL POST HEADER ‚ïê‚ïê */
.post-header{display:flex;align-items:center;gap:7px;margin-bottom:5px;padding-bottom:5px;border-bottom:1px solid rgba(255,255,255,.05);}
.post-channel-name{font-size:11px;color:var(--red-l);font-family:'IBM Plex Mono',monospace;font-weight:600;}
/* ‚ïê‚ïê BUBBLE WRAPPER ‚Äî –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–π ‚ïê‚ïê */
.bwrap{
  position:relative;
  display:inline-flex;
  flex-direction:column;
  max-width:100%;
}
.mw.out .bwrap{align-items:flex-end;}
.mw.in .bwrap{align-items:flex-start;}

/* ‚ïê‚ïê REACTION PICKER ‚Äî –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞–¥ –ø—É–∑—ã—Ä—ë–º –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ ‚ïê‚ïê */
.qact{
  display:none;
  position:absolute;
  bottom:calc(100% + 6px);
  align-items:center;gap:1px;
  background:var(--p1);
  border:1px solid var(--p4);
  border-radius:24px;
  padding:4px 8px;
  box-shadow:0 8px 24px rgba(0,0,0,.8);
  z-index:50;
  white-space:nowrap;
  pointer-events:auto;
}
.mw.out .qact{right:0;}
.mw.in .qact{left:0;}
.bwrap:hover .qact{display:flex;}
.qab{
  width:30px;height:30px;
  border-radius:50%;border:none;
  background:transparent;cursor:pointer;
  font-size:18px;
  display:flex;align-items:center;justify-content:center;
  transition:transform .12s;
  padding:0;
}
.qab:hover{transform:scale(1.35);}
.qab-reply{font-size:14px;color:var(--txt2);}
.qab-reply:hover{color:var(--txt);transform:scale(1.2);}

/* ‚ïê‚ïê REACTIONS ROW ‚ïê‚ïê */
/* ‚ïê‚ïê REACTIONS ROW ‚Äî –ø–æ–¥ –ø—É–∑—ã—Ä—ë–º, –ø–æ —Ç–æ–π –∂–µ —Å—Ç–æ—Ä–æ–Ω–µ ‚ïê‚ïê */
.react-row{
  display:flex;flex-wrap:wrap;gap:3px;
  margin-top:3px;
}
.rpill{
  display:inline-flex;align-items:center;gap:3px;
  padding:2px 8px 2px 5px;
  background:var(--p2);
  border:1px solid var(--p4);
  border-radius:12px;
  font-size:14px;
  cursor:pointer;
  transition:.12s;
  user-select:none;
}
.rpill:hover{border-color:var(--red-l);background:var(--p3);}
.rpill.mine{border-color:var(--red);background:rgba(229,57,53,.15);}
.rpill .rc{font-size:11px;font-weight:700;font-family:'IBM Plex Mono',monospace;color:var(--txt2);}

/* ‚îÄ‚îÄ –°–í–ê–ô–ü –í–õ–ï–í–û = —É–¥–∞–ª–∏—Ç—å —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ ‚îÄ‚îÄ */
.ci{position:relative;overflow:hidden;transition:transform .2s;}
.ci-del-hint{position:absolute;right:0;top:0;bottom:0;width:80px;background:var(--red);display:flex;align-items:center;justify-content:center;font-size:22px;opacity:0;transition:opacity .2s;pointer-events:none;border-radius:0 10px 10px 0;}
/* ‚îÄ‚îÄ –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ –ß–ê–¢–ê ‚îÄ‚îÄ */
.chat-ctx{position:fixed;background:var(--p2);border:1px solid var(--p4);border-radius:12px;padding:6px;z-index:9999;min-width:180px;box-shadow:0 8px 32px rgba(0,0,0,.6);animation:fadeIn .12s;}
.chat-ctx-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:14px;transition:.12s;}
.chat-ctx-item:hover{background:var(--p3);}
.chat-ctx-item.danger{color:#ef5350;}
.chat-ctx-item.danger:hover{background:rgba(229,57,53,.1);}
/* ‚îÄ‚îÄ –°–¢–ê–¢–£–° –ù–ê–ë–û–†–ê ‚îÄ‚îÄ */
.typing-badge{font-size:11px;color:var(--green);font-style:italic;}
/* ‚îÄ‚îÄ –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–ï –í –ó–ê–ì–û–õ–û–í–ö–ï ‚îÄ‚îÄ */
.unread-header{background:var(--red);color:#fff;border-radius:10px;padding:2px 8px;font-size:11px;font-weight:700;margin-left:auto;}
/* ‚îÄ‚îÄ –ü–û–ò–°–ö –ü–û –°–û–û–ë–©–ï–ù–ò–Ø–ú –ì–õ–û–ë–ê–õ–¨–ù–û ‚îÄ‚îÄ */
#globalSrchBar{display:none;flex-shrink:0;padding:8px 12px;background:var(--p1);border-bottom:1px solid var(--p3);gap:8px;align-items:center;}
#globalSrchBar.on{display:flex;}
#globalSrchInp{flex:1;padding:8px 12px;background:var(--p3);border:1px solid var(--p4);border-radius:20px;color:var(--txt);font-size:14px;outline:none;font-family:inherit;}
/* ‚îÄ‚îÄ –ó–ê–ö–†–ï–ü–õ–Å–ù–ù–´–ô –ß–ê–¢ ‚îÄ‚îÄ */
.ci.pinned .cn::before{content:"üìå ";font-size:11px;}
/* ‚îÄ‚îÄ –ü–£–°–¢–û–ô –≠–ö–†–ê–ù –ö–†–ê–°–ò–í–û ‚îÄ‚îÄ */
.nc-empty{display:flex;flex-direction:column;align-items:center;padding:60px 20px;gap:12px;text-align:center;}
.nc-ic{font-size:48px;}
.nc-t{font-size:16px;font-weight:600;color:var(--txt2);}
.nc-s{font-size:13px;color:var(--txt3);line-height:1.6;}
.nc-btn{margin-top:8px;padding:10px 20px;background:var(--red);color:#fff;border:none;border-radius:10px;font-size:14px;cursor:pointer;font-family:inherit;}
/* ‚îÄ‚îÄ –†–ê–ó–î–ï–õ –ó–ê–ö–†–ï–ü–õ–Å–ù–ù–´–• ‚îÄ‚îÄ */
.cl-section{padding:6px 16px 4px;font-size:10px;color:var(--txt3);text-transform:uppercase;letter-spacing:.1em;font-family:IBM Plex Mono,monospace;}
.cl-pinned-badge{font-size:10px;color:var(--txt3);margin-left:4px;}
/* ‚îÄ‚îÄ –†–ê–ó–î–ï–õ–ò–¢–ï–õ–¨ –î–ê–¢–ê-–û–¢–ü–†–ê–í–ò–¢–ï–õ–¨ ‚îÄ‚îÄ */
.starred .ci-star{color:#f0b429;}

</style>
</head>
<body>
<canvas id="particles" style="display:none"></canvas>

<!-- LOADING -->
<div id="gload">
  <div class="gl-wordmark">HARD</div>
  <div class="gl-line"></div>
  <div class="gl-sub">Messenger ¬∑ v4.0 Web</div>
  <div class="gl-progress"><div class="gl-progress-fill"></div></div>
</div>

<!-- TOAST -->
<div id="tc"></div>
<!-- IMG PREVIEW -->
<div class="ipov" id="ipov">
  <span class="ipcl" onclick="closeImgPrev()">‚úï</span>
  <img id="ipimg" src="">
  <button class="ipdown" id="ipdown" onclick="downloadCurrentImg()">‚Üì –°–∫–∞—á–∞—Ç—å</button>
</div>

<!-- CTX BOTTOM SHEET -->
<div class="cxbs" id="cxbs">
  <div class="cxbs-ov" onclick="hideCxbs()"></div>
  <div class="cxbs-body">
    <div style="width:36px;height:4px;background:var(--p4);border-radius:2px;margin:10px auto 14px;"></div>
    <!-- Quick reactions -->
    <div style="display:flex;gap:8px;padding:0 16px 12px;border-bottom:1px solid var(--p3);" id="cxReacts">
      <span style="font-size:26px;cursor:pointer;transition:.15s;" onclick="addReactionCtx('üëç')" ontouchstart="this.style.transform='scale(1.4)'" ontouchend="this.style.transform=''">üëç</span>
      <span style="font-size:26px;cursor:pointer;transition:.15s;" onclick="addReactionCtx('‚ù§Ô∏è')" ontouchstart="this.style.transform='scale(1.4)'" ontouchend="this.style.transform=''">‚ù§Ô∏è</span>
      <span style="font-size:26px;cursor:pointer;transition:.15s;" onclick="addReactionCtx('üòÇ')" ontouchstart="this.style.transform='scale(1.4)'" ontouchend="this.style.transform=''">üòÇ</span>
      <span style="font-size:26px;cursor:pointer;transition:.15s;" onclick="addReactionCtx('üòÆ')" ontouchstart="this.style.transform='scale(1.4)'" ontouchend="this.style.transform=''">üòÆ</span>
      <span style="font-size:26px;cursor:pointer;transition:.15s;" onclick="addReactionCtx('üî•')" ontouchstart="this.style.transform='scale(1.4)'" ontouchend="this.style.transform=''">üî•</span>
      <span style="font-size:26px;cursor:pointer;transition:.15s;" onclick="addReactionCtx('üíÄ')" ontouchstart="this.style.transform='scale(1.4)'" ontouchend="this.style.transform=''">üíÄ</span>
      <span style="font-size:26px;cursor:pointer;transition:.15s;" onclick="addReactionCtx('ü§Ø')" ontouchstart="this.style.transform='scale(1.4)'" ontouchend="this.style.transform=''">ü§Ø</span>
      <span style="font-size:26px;cursor:pointer;transition:.15s;" onclick="addReactionCtx('üíØ')" ontouchstart="this.style.transform='scale(1.4)'" ontouchend="this.style.transform=''">üíØ</span>
    </div>
    <div class="cxi" id="cxCopy">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
    <div class="cxi" id="cxReply">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div>
    <div class="cxi" id="cxFwd">‚Üó –ü–µ—Ä–µ—Å–ª–∞—Ç—å</div>
    <div class="cxi" id="cxPin">üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
    <div class="cxi" id="cxBookmark">üîñ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</div>
    <div class="cxi" id="cxEdit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
    <div class="cxi" id="cxTpl" onclick="hideCxbs();toggleTpl()">üìã –®–∞–±–ª–æ–Ω—ã —Ñ—Ä–∞–∑</div>
    <div class="cx-div"></div>
    <div class="cxi dng" id="cxDel">üóë –£–¥–∞–ª–∏—Ç—å</div>
  </div>
</div>

<!-- MEDIA GALLERY MODAL -->
<div class="mo" id="gallm"><div class="mc" style="max-width:420px;width:100%;">
  <div class="mc-t" style="display:flex;align-items:center;justify-content:space-between;">
    <span>üì∏ –ú–µ–¥–∏–∞</span>
    <button onclick="cm2('gallm')" style="background:none;border:none;color:var(--txt3);font-size:22px;cursor:pointer;">‚úï</button>
  </div>
  <div id="gallGrid" class="gallery-grid"></div>
</div></div>

<!-- MUTE CHAT MODAL -->
<div class="mo" id="mutem"><div class="mc">
  <div class="mc-t">üîï –ó–∞–≥–ª—É—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
  <div class="mc-s">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ —Å–∫–æ–ª—å–∫–æ</div>
  <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">
    <button class="mbtn sec" onclick="muteChatFor(3600000)">–ù–∞ 1 —á–∞—Å</button>
    <button class="mbtn sec" onclick="muteChatFor(86400000)">–ù–∞ 24 —á–∞—Å–∞</button>
    <button class="mbtn sec" onclick="muteChatFor(604800000)">–ù–∞ –Ω–µ–¥–µ–ª—é</button>
    <button class="mbtn dng" onclick="muteChatFor(-1)">–ù–∞–≤—Å–µ–≥–¥–∞</button>
  </div>
  <button class="mbtn sec" onclick="cm2('mutem')">–û—Ç–º–µ–Ω–∞</button>
</div></div>

<!-- MENU BOTTOM SHEET -->
<div class="bsheet" id="menuBS">
  <div class="bs-ov" onclick="closeMenu()"></div>
  <div class="bs-body">
    <div class="bs-handle"></div>
    <div class="bs-hdr">–ú–ï–ù–Æ</div>
    <div class="bs-item" onclick="closeMenu();openMyProfile()"><span class="bs-ic">üë§</span>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
    <div class="bs-item" onclick="closeMenu();openSettings()"><span class="bs-ic">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div class="bs-item" onclick="closeMenu();openHardPlus()"><span class="bs-ic">‚≠ê</span>Hard+ <span class="hp-badge" id="menuHPBadge" style="display:none;margin-left:8px;">ACTIVE</span></div>
    <div class="bs-item" onclick="closeMenu();showOnlineUsers()"><span class="bs-ic">üü¢</span>–û–Ω–ª–∞–π–Ω</div>
    <div class="bs-item" onclick="closeMenu();openCreateGroup()"><span class="bs-ic">üë•</span>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É / –∫–∞–Ω–∞–ª</div>
    <div class="bs-item" onclick="closeMenu();openBookmarks()"><span class="bs-ic">üîñ</span>–ó–∞–∫–ª–∞–¥–∫–∏</div>
    <div class="bs-item" onclick="closeMenu();openChatStats()"><span class="bs-ic">üìä</span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∞—Ç–∞</div>
    <div class="bs-item" onclick="closeMenu();exportChat()"><span class="bs-ic">üì•</span>–≠–∫—Å–ø–æ—Ä—Ç —á–∞—Ç–∞</div>
    <div class="bs-div"></div>
    <div class="bs-item" onclick="closeMenu();logoutUser()"><span class="bs-ic">üö™</span>–í—ã–π—Ç–∏</div>
    <div style="padding:8px 20px;font-size:11px;color:var(--txt3);font-family:'IBM Plex Mono',monospace;">HARD ¬∑ v4.0 Web ¬∑ 2026</div>
  </div>
</div>

<!-- CHAT ACTIONS SHEET -->
<div class="bsheet" id="chatActBS">
  <div class="bs-ov" onclick="closeChatAct()"></div>
  <div class="bs-body">
    <div class="bs-handle"></div>
    <div class="bs-item" onclick="closeChatAct();openGif()"><span class="bs-ic">üé¨</span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å GIF</div>
    <div class="bs-item" onclick="closeChatAct();openStickers()"><span class="bs-ic">üé≠</span>–°—Ç–∏–∫–µ—Ä—ã</div>
    <div class="bs-item" onclick="closeChatAct();trigFile()"><span class="bs-ic">üìé</span>–§–∞–π–ª / —Ñ–æ—Ç–æ</div>
    <div class="bs-item" onclick="closeChatAct();openEmojiPicker()"><span class="bs-ic">üòä</span>–≠–º–æ–¥–∑–∏</div>
    <div class="bs-item" onclick="closeChatAct();toggleFmtBar()"><span class="bs-ic">‚úçÔ∏è</span>–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
    <div class="bs-item" id="sdActBtn" onclick="closeChatAct();toggleSelfDestruct()"><span class="bs-ic">üí£</span><span id="sdActTxt">–°–∞–º–æ—É–¥–∞–ª–µ–Ω–∏–µ OFF</span></div>
    <div class="bs-item" onclick="closeChatAct();openUserProfile()"><span class="bs-ic">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</div>
    <div class="bs-item" onclick="closeChatAct();toggleChatSearch()"><span class="bs-ic">üîç</span>–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç—É</div>
    <div class="bs-item" onclick="closeChatAct();openGallery()"><span class="bs-ic">üì∏</span>–ú–µ–¥–∏–∞–≥–∞–ª–µ—Ä–µ—è</div>
    <div class="bs-item" onclick="closeChatAct();openMuteModal()"><span class="bs-ic" id="muteIc">üîï</span><span id="muteTxt">–ó–∞–≥–ª—É—à–∏—Ç—å —á–∞—Ç</span></div>
    <div class="bs-item" onclick="closeChatAct();confirmDelChat()"><span class="bs-ic" style="color:#ef9a9a;">üóëÔ∏è</span><span style="color:#ef9a9a;">–£–¥–∞–ª–∏—Ç—å —á–∞—Ç</span></div>
  </div>
</div>

<!-- AUTH: LOGIN -->
<div id="lw" class="auth-screen">
  <div class="auth-card">
    <div class="a-brand">
      <span class="a-brand-name">HARD<span class="a-brand-dot"></span></span>
      <span class="a-brand-sub">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</span>
    </div>
    <div class="alrt err" id="le"></div>
    <div class="ff"><label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label><input type="text" id="lu" placeholder="username" autocomplete="username" autocapitalize="none"></div>
    <div class="ff"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="lp" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
    <button class="auth-btn" id="lbtn" onclick="doLogin()">–í–æ–π—Ç–∏</button>
    <div class="auth-sw">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="showSc('rw')">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></div>
  </div>
</div>

<!-- AUTH: REGISTER -->
<div id="rw" class="auth-screen">
  <div class="auth-card">
    <div class="a-brand">
      <span class="a-brand-name">HARD<span class="a-brand-dot"></span></span>
      <span class="a-brand-sub">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
    </div>
    <div class="alrt err" id="re"></div>
    <div class="alrt ok" id="ro"></div>
    <div class="ff"><label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label><input type="text" id="ru" placeholder="–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞" autocapitalize="none"></div>
    <div class="ff"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="rp" placeholder="–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤"></div>
    <div class="ff"><label>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label><input type="password" id="rp2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
    <button class="auth-btn" id="rbtn" onclick="doRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <div class="auth-sw">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="showSc('lw')">–í–æ–π—Ç–∏</a></div>
  </div>
</div>

<!-- APP -->
<div id="app">

  <!-- LIST VIEW -->
  <div id="viewList">
    <div class="topbar">
      <span class="tb-title">HARD<span style="color:var(--red);font-size:20px;">¬∑</span><span id="unreadBadge"></span></span>
      <div class="online-count" id="onlineCount"><span class="online-dot"></span><span id="onlineNum">0</span></div>
      <button class="tb-ico" onclick="openMenu()">‚ò∞</button>
      <img class="tb-ava" id="topAva" src="" onclick="openMyProfile()">
    </div>
    <div class="sw-wrap">
      <div class="si-wrap" style="position:relative;">
        <span class="si-ic">üîç</span>
        <input class="si" id="si" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É..." oninput="onSearch(this.value)" autocomplete="off" autocapitalize="none" onfocus="onSearchFocus()" onblur="onSearchBlur()">
        <button id="siClear" onclick="clearSearch()">‚úï</button>
      </div>
      <div id="searchHint" class="search-hint" style="display:none;"></div>
    </div>
    <div class="cl" id="cl"><div class="nc">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    <!-- FAB: New chat -->
    <button id="newChatBtn" onclick="focusSearch()" title="–ù–æ–≤—ã–π —á–∞—Ç">‚úé</button>
  </div>

  <!-- CHAT VIEW -->
  <div id="viewChat">
    <div class="chat-topbar">
      <button class="tb-ico" onclick="goBack()" style="margin-left:-4px;">‚Üê</button>
      <img class="chat-ava" id="chav" src="" onclick="openUserProfile()">
      <div class="chat-info">
        <div class="chat-name" id="chn">‚Äî</div>
        <div class="chat-st" id="chs">‚Äî</div>
      </div>
      <div class="chat-acts">
        <button class="tb-ico" id="srchBtn" onclick="toggleChatSearch()">üîç</button>
        <button class="tb-ico" onclick="openChatAct()">‚ãÆ</button>
      </div>
    </div>

    <!-- Chat Search Bar -->
    <div id="chatSB" style="display:none;padding:7px 10px;background:var(--p1);border-bottom:1px solid var(--p3);align-items:center;gap:6px;">
      <input id="chatSI" placeholder="–ü–æ–∏—Å–∫..." style="flex:1;padding:8px 12px;background:var(--p2);border:1px solid var(--p4);border-radius:10px;color:var(--txt);font-size:14px;outline:none;font-family:inherit;" oninput="searchMsgs(this.value)" autocomplete="off">
      <span id="srchInfo" style="font-size:11px;color:var(--txt3);white-space:nowrap;font-family:'IBM Plex Mono',monospace;"></span>
      <button class="tb-ico" onclick="navSearch(-1)">‚Üë</button>
      <button class="tb-ico" onclick="navSearch(1)">‚Üì</button>
      <button class="tb-ico" onclick="closeChatSearch()">‚úï</button>
    </div>

    <!-- Format bar -->
    <div id="fmtBar">
      <button class="fmt-btn" onclick="insertFmt('**','**')">ùêÅ</button>
      <button class="fmt-btn" onclick="insertFmt('_','_')"><em>I</em></button>
      <button class="fmt-btn" onclick="insertFmt('~~','~~')"><s>S</s></button>
      <button class="fmt-btn" onclick="insertFmt('`','`')">&#60;/&#62;</button>
      <button class="fmt-btn" onclick="insertFmt('\n```\n','\n```')">üìã</button>
    </div>

    <!-- Pinned -->
    <div id="pinnedBar" onclick="scrollToPin()">
      <div class="pin-line"></div>
      <div class="pin-info"><div class="pin-label">üìå PINNED</div><div class="pin-text" id="pinText">‚Äî</div></div>
      <button onclick="event.stopPropagation();clearPin()" style="background:none;border:none;color:var(--txt3);cursor:pointer;font-size:18px;padding:6px;">‚úï</button>
    </div>

    <!-- Messages -->
    <div class="ma" id="ma" style="position:relative;"><button id="jumpTopBtn" title="–ö –Ω–∞—á–∞–ª—É" onclick="scrollToTop()">‚Üë</button></div>

    <!-- Typing -->
    <div class="twrap" id="twrap"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div><span id="twho" style="margin-left:5px;font-size:13px;">–ø–µ—á–∞—Ç–∞–µ—Ç...</span></div>

    <!-- Forward bar -->
    <div id="fwdBar"><div style="display:flex;align-items:center;gap:8px;"><span style="font-size:14px;color:var(--gold);">‚Üó –ü–µ—Ä–µ—Å—ã–ª–∫–∞:</span><span id="fwdPrev" style="font-size:13px;color:var(--txt2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">‚Äî</span><button onclick="clearFwd()" style="background:none;border:none;color:var(--txt3);font-size:18px;cursor:pointer;">‚úï</button></div></div>

    <!-- Reply -->
    <div id="replyBar"><div class="reply-inner"><div class="ri-txt"><div class="ri-who">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div><div class="ri-prev" id="replyPrev">‚Äî</div></div><button class="ri-x" onclick="clearReply()">‚úï</button></div></div>

    <!-- Edit bar -->
    <div class="edit-bar" id="editBar"><span>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:</span><span class="edit-tag" id="editPrev"></span><button class="edit-cancel" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button></div>
    <!-- Templates bar -->
    <div id="tplBar">
      <span class="tpl" onclick="useTpl('üëã –ü—Ä–∏–≤–µ—Ç!')">üëã –ü—Ä–∏–≤–µ—Ç</span>
      <span class="tpl" onclick="useTpl('–û–∫–µ–π, –ø–æ–Ω—è–ª üëç')">üëç –û–∫–µ–π</span>
      <span class="tpl" onclick="useTpl('–ò–¥—É —Å–µ–π—á–∞—Å ‚úÖ')">üèÉ –ò–¥—É</span>
      <span class="tpl" onclick="useTpl('–ë—É–¥—É –ø–æ–∑–∂–µ ‚è∞')">‚è∞ –ü–æ–∑–∂–µ</span>
      <span class="tpl" onclick="useTpl('–°–ø–∞—Å–∏–±–æ! üôè')">üôè –°–ø–∞—Å–∏–±–æ</span>
      <span class="tpl" onclick="useTpl('–ù–µ –º–æ–≥—É —Å–µ–π—á–∞—Å üö´')">üö´ –ó–∞–Ω—è—Ç</span>
      <span class="tpl" onclick="useTpl('–•–∞-—Ö–∞-—Ö–∞ üòÇ')">üòÇ –•–∞</span>
      <span class="tpl" onclick="useTpl('–ü–æ—Å–º–æ—Ç—Ä—é –ø–æ–∑–∂–µ üëÄ')">üëÄ –ü–æ–∑–∂–µ</span>
    </div>
    <!-- Emoji Picker -->
    <div id="emojiPicker">
      <div class="emoji-cats" id="emojiCats"></div>
      <div class="emoji-grid" id="emojiGrid"></div>
    </div>

    <!-- Input -->
    <div class="ia-wrap">
      <input type="file" id="fatt" style="display:none" onchange="sendFile(this)" multiple>
      <div class="ia" id="mainIA">
        <button class="abtn" onclick="openChatAct()">Ôºã</button>
        <div id="voiceRec">
          <div class="vrec-wave"><div class="vrec-bar"></div><div class="vrec-bar"></div><div class="vrec-bar"></div><div class="vrec-bar"></div><div class="vrec-bar"></div></div>
          <div class="vrec-time" id="vtime">0:00</div>
          <button class="vrec-btn vrec-cancel" onclick="cancelVoice()">‚úï</button>
          <button class="vrec-btn vrec-send" onclick="sendVoice()">‚û§</button>
        </div>
        <textarea class="mi2" id="mi" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
        <button class="abtn" id="voiceBtn" ontouchstart="startVoiceRec()" ontouchend="stopVoiceRec()" onmousedown="startVoiceRec()" onmouseup="stopVoiceRec()" style="color:var(--txt2)">üé§</button>
        <button class="sbtn" onclick="sendMsg()">‚û§</button>
      </div>
    </div>
    <button id="scrollBtn" onclick="scrollToBottom(true)">‚Üì<span class="sbu" id="sbu"></span></button>
  </div>
</div>

<!-- MODALS -->
<!-- My Profile -->
<div class="mo" id="mpm"><div class="mc">
  <img class="pma" id="mpa" src="">
  <div style="text-align:center;margin-bottom:14px;">
    <div class="mc-t" id="mpn" style="font-size:20px;">‚Äî</div>
    <div style="font-size:13px;color:var(--green);margin-top:3px;">‚óè –í —Å–µ—Ç–∏</div>
  </div>
  <div class="pir"><span class="pil">username</span><span id="mpun">‚Äî</span></div>
  <div class="pir"><span class="pil">id</span><span id="mpid" style="font-size:11px;">‚Äî</span></div>
  <div class="pir"><span class="pil">—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span><span id="mpcr">‚Äî</span></div>
  <div class="pir"><span class="pil">—Å–æ–æ–±—â–µ–Ω–∏–π</span><span id="mpMsgCount" style="color:var(--red);font-family:'IBM Plex Mono',monospace;font-weight:700;">‚Äî</span></div>
  <div class="mac"><button class="mbtn sec" onclick="cm2('mpm')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<!-- User Profile -->
<div class="mo" id="upm"><div class="mc">
  <img class="pma" id="upa" src="">
  <div style="text-align:center;margin-bottom:14px;">
    <div class="mc-t" id="upn" style="font-size:20px;">‚Äî</div>
    <div style="font-size:13px;margin-top:3px;" id="ups">‚Äî</div>
  </div>
  <div class="mac">
    <button class="mbtn dng" onclick="confirmDelChat()">–£–¥–∞–ª–∏—Ç—å —á–∞—Ç</button>
    <button class="mbtn sec" onclick="cm2('upm')">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div></div>

<!-- Confirm -->
<div class="mo" id="cfm"><div class="mc">
  <div class="mc-t" id="cft">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
  <div class="mc-s" id="cfs">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</div>
  <div class="mac"><button class="mbtn sec" onclick="cm2('cfm')">–û—Ç–º–µ–Ω–∞</button><button class="mbtn dng" id="cfb">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button></div>
</div></div>

<!-- Online -->
<div class="mo" id="olm"><div class="mc">
  <div class="mc-t">üü¢ –û–Ω–ª–∞–π–Ω</div>
  <div id="oll" style="margin:12px 0;max-height:260px;overflow-y:auto;"></div>
  <div class="mac"><button class="mbtn sec" onclick="cm2('olm')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<!-- Edit Msg -->
<div class="mo" id="editm"><div class="mc">
  <div class="mc-t">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
  <textarea id="editTxt" style="width:100%;padding:11px;background:var(--p2);border:1px solid var(--p4);border-radius:10px;color:var(--txt);font-size:15px;resize:none;height:80px;outline:none;font-family:inherit;margin:12px 0;"></textarea>
  <div class="mac"><button class="mbtn sec" onclick="cm2('editm')">–û—Ç–º–µ–Ω–∞</button><button class="mbtn prim" id="editSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
</div></div>

<!-- Settings -->
<div class="mo" id="sp"><div class="mc">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
    <button class="tb-ico" onclick="cm2('sp')" style="font-size:20px;">‚Üê</button>
    <div style="font-size:17px;font-weight:700;font-family:'IBM Plex Mono',monospace;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  </div>
  <div class="sg"><div class="sg-t">–ó–≤—É–∫</div>
    <div class="sr"><div><div class="sl">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div><div class="ss">–ë–∏–ø –ø—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</div></div><label class="tgl"><input type="checkbox" id="sndT" checked onchange="sv('sound',this.checked)"><span class="tgl-t"></span><span class="tgl-th"></span></label></div>
  </div>
  <div class="sg"><div class="sg-t">–ê–∫–∫–∞—É–Ω—Ç</div>
    <div class="sr"><div><div class="sl">–ê–≤–∞—Ç–∞—Ä</div></div><label style="cursor:pointer;color:var(--red-l);font-family:'IBM Plex Mono',monospace;font-size:12px;"><input type="file" accept="image/*" id="chavi" style="display:none" onchange="changeAvatar(this)">–ò–∑–º–µ–Ω–∏—Ç—å</label></div>
    <div class="sr"><div><div class="sl">–û–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å</div><div class="ss">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥—Ä—É–≥–∏–º</div></div><label class="tgl"><input type="checkbox" id="onlT" checked onchange="toggleOnlineSt(this.checked)"><span class="tgl-t"></span><span class="tgl-th"></span></label></div>
  </div>
  <div class="sg"><div class="sg-t">–ß–∞—Ç</div>
    <div class="sr"><div><div class="sl">–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞</div></div>
      <select onchange="setFontSize(this.value)" id="fontSzSel" style="background:var(--p3);border:1px solid var(--p4);border-radius:7px;color:var(--txt);padding:5px 10px;font-family:inherit;outline:none;">
        <option value="13">–ú–µ–ª–∫–∏–π</option>
        <option value="15" selected>–û–±—ã—á–Ω—ã–π</option>
        <option value="17">–ö—Ä—É–ø–Ω—ã–π</option>
      </select>
    </div>
    <div class="sr"><div><div class="sl">–°–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–µ —É–≥–ª—ã</div><div class="ss">–§–æ—Ä–º–∞ –ø—É–∑—ã—Ä–µ–π</div></div><label class="tgl"><input type="checkbox" id="roundT" checked onchange="sv('rounded',this.checked);document.documentElement.style.setProperty('--msg-radius',this.checked?'18px':'8px')"><span class="tgl-t"></span><span class="tgl-th"></span></label></div>
  </div>
</div></div>

<!-- HARD+ -->
<div class="mo" id="hpm"><div class="mc">
  <div class="hplus-hero">
    <div class="hplus-hero-title">‚≠ê HARD+</div>
    <div class="hplus-hero-sub" id="hpStatus">–í–≤–µ–¥–∏ –ø—Ä–æ–º–æ–∫–æ–¥ —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</div>
  </div>
  <div id="hpPromoSection">
    <input class="hp-promo-inp" id="hpCodeInp" placeholder="–ø—Ä–æ–º–æ–∫–æ–¥..." maxlength="20" autocapitalize="none">
    <button class="hp-promo-btn" onclick="activateHardPlus()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>
  <div id="hpFeatures" style="margin-top:14px;">
    <div class="sg-t">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</div>
    <div id="hp-badge-ctrl" style="display:none;margin-bottom:14px;">
      <div class="sl" style="margin-bottom:6px;">üè∑ –¢–∞–π—Ç–ª –∫ –Ω–∏–∫—É</div>
      <div style="display:flex;gap:6px;margin-bottom:8px;">
        <input id="titleInp" maxlength="12" placeholder="–Ω–∞–ø—Ä. BOSS" autocapitalize="none" style="flex:1;padding:10px 12px;background:var(--p2);border:1px solid var(--p4);border-radius:8px;color:var(--txt);font-size:15px;outline:none;font-family:'IBM Plex Mono',monospace;">
        <button onclick="applyUserTitle()" style="padding:10px 14px;background:var(--gold);color:#000;border:none;border-radius:8px;font-weight:700;font-size:15px;cursor:pointer;">OK</button>
        <button onclick="clearUserTitle()" style="padding:10px 12px;background:var(--p3);color:var(--txt2);border:1px solid var(--p4);border-radius:8px;font-size:14px;cursor:pointer;">‚úï</button>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button onclick="setTitleColor('#f0b429')" style="width:28px;height:28px;background:#f0b429;border-radius:6px;border:2px solid transparent;cursor:pointer;"></button>
        <button onclick="setTitleColor('#e53935')" style="width:28px;height:28px;background:#e53935;border-radius:6px;border:2px solid transparent;cursor:pointer;"></button>
        <button onclick="setTitleColor('#00e5cc')" style="width:28px;height:28px;background:#00e5cc;border-radius:6px;border:2px solid transparent;cursor:pointer;"></button>
        <button onclick="setTitleColor('#9c27b0')" style="width:28px;height:28px;background:#9c27b0;border-radius:6px;border:2px solid transparent;cursor:pointer;"></button>
        <button onclick="setTitleColor('#43a047')" style="width:28px;height:28px;background:#43a047;border-radius:6px;border:2px solid transparent;cursor:pointer;"></button>
        <button onclick="setTitleColor('#1e88e5')" style="width:28px;height:28px;background:#1e88e5;border-radius:6px;border:2px solid transparent;cursor:pointer;"></button>
        <button onclick="setTitleColor('#fff')" style="width:28px;height:28px;background:#fff;border-radius:6px;border:2px solid transparent;cursor:pointer;"></button>
      </div>
    </div>
    <div id="hp-status-ctrl" style="display:none;margin-bottom:14px;">
      <div class="sl" style="margin-bottom:6px;">üí¨ –°—Ç–∞—Ç—É—Å-—Ç–µ–∫—Å—Ç</div>
      <div style="display:flex;gap:6px;margin-bottom:8px;">
        <input id="statusInp" maxlength="40" placeholder="–ó–∞–Ω—è—Ç..." style="flex:1;padding:10px 12px;background:var(--p2);border:1px solid var(--p4);border-radius:8px;color:var(--txt);font-size:15px;outline:none;font-family:inherit;">
        <button onclick="applyStatusText()" style="padding:10px 14px;background:var(--gold);color:#000;border:none;border-radius:8px;font-weight:700;font-size:15px;cursor:pointer;">OK</button>
      </div>
      <div style="display:flex;gap:5px;flex-wrap:wrap;">
        <button onclick="quickStatus('üéÆ –í –∏–≥—Ä–µ')" style="padding:6px 10px;background:var(--p3);border:1px solid var(--p4);border-radius:14px;color:var(--txt2);font-size:13px;cursor:pointer;">üéÆ –í –∏–≥—Ä–µ</button>
        <button onclick="quickStatus('üéµ –ú—É–∑—ã–∫–∞')" style="padding:6px 10px;background:var(--p3);border:1px solid var(--p4);border-radius:14px;color:var(--txt2);font-size:13px;cursor:pointer;">üéµ –ú—É–∑—ã–∫–∞</button>
        <button onclick="quickStatus('üò¥ –°–ø–ª—é')" style="padding:6px 10px;background:var(--p3);border:1px solid var(--p4);border-radius:14px;color:var(--txt2);font-size:13px;cursor:pointer;">üò¥ –°–ø–ª—é</button>
        <button onclick="quickStatus('üìµ –î–ù–î')" style="padding:6px 10px;background:var(--p3);border:1px solid var(--p4);border-radius:14px;color:var(--txt2);font-size:13px;cursor:pointer;">üìµ –î–ù–î</button>
        <button onclick="quickStatus('üíª –ö–æ–¥—é')" style="padding:6px 10px;background:var(--p3);border:1px solid var(--p4);border-radius:14px;color:var(--txt2);font-size:13px;cursor:pointer;">üíª –ö–æ–¥—é</button>
        <button onclick="quickStatus('')" style="padding:6px 10px;background:var(--p3);border:1px solid var(--p4);border-radius:14px;color:var(--txt2);font-size:13px;cursor:pointer;">‚úï –£–±—Ä–∞—Ç—å</button>
      </div>
    </div>
    <div id="hp-themes-ctrl" style="display:none;margin-bottom:14px;">
      <div class="sl" style="margin-bottom:8px;">üé® –¢–µ–º–∞</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button class="theme-btn" onclick="setTheme('default')">Default</button>
        <button class="theme-btn" onclick="setTheme('glitch')">Glitch</button>
        <button class="theme-btn" onclick="setTheme('cyber')">Cyber</button>
        <button class="theme-btn" onclick="setTheme('purple')">Purple</button>
        <button class="theme-btn" onclick="setTheme('gold')">Gold</button>
        <button class="theme-btn" onclick="setTheme('ocean')">Ocean</button>
        <button class="theme-btn" onclick="setTheme('forest')">Forest</button>
      </div>
    </div>
  </div>
  <div class="mac"><button class="mbtn sec" onclick="cm2('hpm')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<!-- Stickers -->
<div class="mo" id="stkm"><div class="mc">
  <div class="mc-t">üé≠ –°—Ç–∏–∫–µ—Ä—ã</div>
  <div id="stkGrid" style="margin:12px 0;"></div>
  <div class="mac"><button class="mbtn sec" onclick="cm2('stkm')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<!-- GIF -->
<div class="mo" id="gifMo"><div class="mc">
  <div class="mc-t">üé¨ GIF</div>
  <input class="gif-search" id="gifSearchI" placeholder="–ü–æ–∏—Å–∫ GIF..." oninput="searchGif(this.value)" autocomplete="off">
  <div id="gifGrid"></div>
  <div class="mac" style="margin-top:10px;"><button class="mbtn sec" onclick="cm2('gifMo')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<!-- Stats -->
<div class="mo" id="statsMo"><div class="mc">
  <div class="mc-t">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
  <div class="stats-row">
    <div class="stat-card"><span class="stat-num" id="st-total">0</span><span class="stat-lbl">–í—Å–µ–≥–æ</span></div>
    <div class="stat-card"><span class="stat-num" id="st-mine">0</span><span class="stat-lbl">–ú–æ–∏—Ö</span></div>
    <div class="stat-card"><span class="stat-num" id="st-media">0</span><span class="stat-lbl">–ú–µ–¥–∏–∞</span></div>
  </div>
  <div id="st-firstMsg" style="margin-top:12px;font-size:13px;color:var(--txt2);"></div>
  <div id="st-words" style="margin-top:6px;font-size:13px;color:var(--txt2);"></div>
  <div class="mac" style="margin-top:12px;"><button class="mbtn sec" onclick="cm2('statsMo')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<!-- Bookmarks -->
<div class="mo" id="bkMo"><div class="mc">
  <div class="mc-t">üîñ –ó–∞–∫–ª–∞–¥–∫–∏</div>
  <div id="bkList" style="margin:12px 0;max-height:300px;overflow-y:auto;"></div>
  <div class="mac"><button class="mbtn sec" onclick="cm2('bkMo')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<!-- Forward modal - select contact -->
<div class="mo" id="fwdMo"><div class="mc">
  <div class="mc-t">‚Üó –ü–µ—Ä–µ—Å–ª–∞—Ç—å</div>
  <div class="mc-s">–í—ã–±–µ—Ä–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</div>
  <div id="fwdContacts" style="max-height:280px;overflow-y:auto;margin-bottom:12px;"></div>
  <div class="mac"><button class="mbtn sec" onclick="cm2('fwdMo')">–û—Ç–º–µ–Ω–∞</button></div>
</div></div>

<script>
function tbMin(){}function tbMaximize(){}function tbClose(){}

// –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ ‚Äî –Ω–µ –∂–¥—ë–º Firebase
window.addEventListener('DOMContentLoaded', function(){
  // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º loading screen ‚Äî –Ω–µ –∂–¥—ë–º Firebase
  var gl = document.getElementById('gload');
  if(gl){ gl.style.opacity='0'; setTimeout(function(){ gl.style.display='none'; }, 400); }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç Firebase)
  setTimeout(function(){
    ['lw','rw'].forEach(function(s){
      var e=document.getElementById(s);
      if(e){e.style.display='none';e.classList.remove('on');}
    });
    var app=document.getElementById('app');
    if(app) app.style.display='none';
    var lw=document.getElementById('lw');
    if(lw){lw.style.display='flex';lw.classList.add('on');}
    // –ß–∞—Å—Ç–∏—Ü—ã —Ñ–æ–Ω–∞
    for(var i=0;i<8;i++){
      var p=document.createElement('div');
      p.className='part';
      p.style.cssText='left:'+Math.random()*100+'%;width:'+(Math.random()*3+1)+'px;height:'+(Math.random()*3+1)+'px;animation-duration:'+(Math.random()*20+10)+'s;animation-delay:'+(Math.random()*10)+'s;';
      document.body.appendChild(p);
    }
  }, 400);
  
  // Fallback: –µ—Å–ª–∏ Firebase –∑–∞–≤–∏—Å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫
  window._firebaseTimeout = setTimeout(function(){
    if(typeof window._firebaseReady !== 'undefined') return;
    var lw=document.getElementById('lw');
    if(lw && !lw.classList.contains('on')){
      lw.style.display='flex'; lw.classList.add('on');
    }
    var alrt=document.getElementById('le');
    if(alrt){ alrt.textContent='‚ö† –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.'; alrt.className='alrt err'; alrt.style.display='block'; }
  }, 10000);
});
</script>

<!-- Firebase UMD ‚Äî –æ–±—ã—á–Ω—ã–µ script —Ç–µ–≥–∏, –Ω–µ ES module, –≥—Ä—É–∑—è—Ç—Å—è –Ω–∞–¥—ë–∂–Ω–µ–µ -->
<script>

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE REST SHIM ‚Äî –±–µ–∑ SDK, —Ç–æ–ª—å–∫–æ fetch
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _DB = 'https://mymessenger-dbf1e-default-rtdb.firebaseio.com';

function _url(path) {
  if(!path) return _DB + '/.json';
  return _DB + '/' + path.replace(/^\//, '') + '.json';
}

function ref(db, path) {
  return { _path: path || '' };
}

function get(r) {
  return fetch(_url(r._path))
    .then(function(res) { return res.json(); })
    .then(function(data) {
      return { val: function() { return data; }, exists: function() { return data !== null && data !== undefined; } };
    });
}

function set(r, v) {
  return fetch(_url(r._path), {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(v)
  }).then(function(r) { return r.json(); });
}

function update(r, v) {
  return fetch(_url(r._path), {
    method: 'PATCH',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(v)
  }).then(function(r) { return r.json(); });
}

function remove(r) {
  return fetch(_url(r._path), { method: 'DELETE' }).then(function(r) { return r.json(); });
}

function push(r, v) {
  if(v === undefined) {
    var key = '-' + Date.now().toString(36) + Math.random().toString(36).substr(2,6);
    return { key: key, _path: r._path + '/' + key };
  }
  return fetch(_url(r._path), {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(v)
  }).then(function(res) { return res.json(); }).then(function(d) { return { key: d.name, _path: r._path + '/' + d.name }; });
}

// onValue —á–µ—Ä–µ–∑ –ø–æ–ª–ª–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
function onValue(r, cb) {
  var lastVal = '__INIT__';
  function poll() {
    fetch(_url(r._path))
      .then(function(res) { return res.json(); })
      .then(function(data) {
        var s = JSON.stringify(data);
        if(s !== lastVal) {
          lastVal = s;
          cb({ val: function() { return data; }, exists: function() { return data !== null; } });
        }
      })
      .catch(function() {});
  }
  poll();
  var iv = setInterval(poll, 3000);
  return function() { clearInterval(iv); };
}

function onDisconnect(r) {
  return {
    set: function(v) {
      window.addEventListener('beforeunload', function() {
        try { navigator.sendBeacon(_url(r._path) + '?x-http-method-override=PUT', JSON.stringify(v)); } catch(e) {}
      });
      return Promise.resolve();
    }
  };
}

</script>

<script>
// –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
window._hardMainInit = function(){
window._firebaseReady = true;
clearTimeout(window._firebaseTimeout);
const db = {}; // –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –≤—Å–µ –≤—ã–∑–æ–≤—ã —á–µ—Ä–µ–∑ shim

let CU=null,CC=null;
let msgUnsub=null,cUnsub=null,stUnsub=null;
let allC=[],unread={},selMsg=null,editMsg=null;
let typTO=null,replyTo=null,fwdMsg=null,pinMsgId=null;
let srchResults=[],srchI=0,newMsgCount=0;
let voiceRec=null,voiceStream=null,voiceTimer=null,voiceTime=0;
let contactLastMsgCache={};
let voiceAudios={};
let gifTO=null;
let bookmarks=JSON.parse(localStorage.getItem('hard_bk')||'[]');
const S=JSON.parse(localStorage.getItem('hard_s')||'{"sound":true,"rounded":true}');

// ‚îÄ‚îÄ NEW: Starred contacts & drafts ‚îÄ‚îÄ
let starredContacts = JSON.parse(localStorage.getItem('hard_stars')||'[]');
let drafts = JSON.parse(localStorage.getItem('hard_drafts')||'{}'); // uid -> text

function toggleStar(uid){
  const idx = starredContacts.indexOf(uid);
  if(idx>=0) starredContacts.splice(idx,1);
  else starredContacts.push(uid);
  localStorage.setItem('hard_stars', JSON.stringify(starredContacts));
  renderChats(chatContacts);
  toast(starredContacts.includes(uid)?'‚≠ê –î–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ':'–£–±—Ä–∞–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ','ok');
}
function saveDraft(uid, text){
  if(!uid) return;
  if(text && text.trim()) drafts[uid] = text;
  else delete drafts[uid];
  localStorage.setItem('hard_drafts', JSON.stringify(drafts));
}
function loadDraft(uid){
  return drafts[uid]||'';
}


// Expose functions

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NEW FEATURES v4.1 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// Edit message state
let editingMsgId = null;
let editingMsgRef = null;

function startEdit() {
  if(!selMsg || selMsg.type || selMsg.from !== CU.id) return;
  editingMsgId = selMsg.id;
  const inp = document.getElementById('mi');
  inp.value = selMsg.text || '';
  inp.focus();
  document.getElementById('editBar').classList.add('on');
  document.getElementById('editPrev').textContent = (selMsg.text||'').substring(0,50);
  hideCxbs();
}

function cancelEdit() {
  editingMsgId = null;
  document.getElementById('editBar').classList.remove('on');
  document.getElementById('mi').value = '';
}

// Patch sendMsg to handle edit mode
const _origSend = window.sendMsg || sendMsg;

// Templates toggle
function toggleTpl() {
  document.getElementById('tplBar').classList.toggle('on');
}
function useTpl(txt) {
  document.getElementById('mi').value = txt;
  document.getElementById('mi').focus();
  document.getElementById('tplBar').classList.remove('on');
}

// Scroll to top
function scrollToTop() {
  document.getElementById('ma').scrollTo({ top: 0, behavior: 'smooth' });
}

// Jump-to-top button toggle on scroll
document.getElementById('ma').addEventListener('scroll', function() {
  const btn = document.getElementById('jumpTopBtn');
  if (btn) btn.classList.toggle('on', this.scrollTop > 500);
}, { passive: true });

// Parse @mentions in text
function parseMentions(html) {
  if (!CU) return html;
  return html.replace(/@(\w+)/g, (m, name) => {
    if (name.toLowerCase() === (CU.username||'').toLowerCase())
      return `<span class="mention-me">@${name}</span>`;
    return `<span class="mention">@${name}</span>`;
  });
}

// Dice roll command
function rollDice() {
  const faces = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'];
  return { face: faces[Math.floor(Math.random()*6)], val: Math.floor(Math.random()*6)+1 };
}
function playClink() {
  try {
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    [350,700,1050].forEach((freq, i) => {
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = freq; g.gain.value = 0.04;
      o.start(ctx.currentTime + i * 0.07);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + i*0.07 + 0.12);
      setTimeout(() => { try{o.stop();}catch(e){} }, (i+1)*100);
    });
    setTimeout(() => ctx.close(), 500);
  } catch(e) {}
}

// Double-tap to react ‚ù§Ô∏è
(function(){
  let lastTap = 0, lastMb = null;
  document.getElementById('ma').addEventListener('touchend', e => {
    const mb = e.target.closest('.mb');
    if (!mb) return;
    const now = Date.now();
    if (now - lastTap < 280 && lastMb === mb) {
      // Double tap!
      const mw = mb.closest('.mw');
      if (mw && mw.dataset.mid) {
        addReaction(mw.dataset.mid, '‚ù§Ô∏è');
        // Floating heart
        const h = document.createElement('div');
        h.className = 'float-heart';
        h.textContent = '‚ù§Ô∏è';
        const t = e.changedTouches[0];
        h.style.left = (t.clientX - 16) + 'px';
        h.style.top  = (t.clientY - 16) + 'px';
        document.body.appendChild(h);
        setTimeout(() => h.remove(), 700);
      }
    }
    lastTap = now; lastMb = mb;
  }, { passive: true });
})();

// Swipe right to reply
(function(){
  let sx=0, sy=0, el=null;
  document.getElementById('ma').addEventListener('touchstart', e => {
    sx = e.touches[0].clientX; sy = e.touches[0].clientY;
    el = e.target.closest('.mw');
  }, { passive: true });
  document.getElementById('ma').addEventListener('touchmove', e => {
    if (!el) return;
    const dx = e.touches[0].clientX - sx;
    const dy = Math.abs(e.touches[0].clientY - sy);
    if (dy > 25) { el = null; return; }
    if (dx > 0 && dx < 80) {
      el.style.cssText += `;transform:translateX(${dx * 0.6}px);transition:none;`;
    }
  }, { passive: true });
  document.getElementById('ma').addEventListener('touchend', e => {
    if (!el) return;
    const dx = e.changedTouches[0].clientX - sx;
    el.style.transform = '';
    el.style.transition = 'transform .2s';
    if (dx > 50 && el.dataset.mid) {
      const txt  = el.querySelector('.mb')?.innerText?.substring(0,80) || '';
      const isOut = el.classList.contains('out');
      setReply(el.dataset.mid, txt, isOut ? '–í—ã' : (CC?.username||'?'));
    }
    el = null;
  }, { passive: true });
})();

// Unread badge updater
function refreshUnreadBadge() {
  const total = Object.values(unread||{}).reduce((a,b) => a+(b||0), 0);
  const el = document.getElementById('unreadBadge');
  if (!el) return;
  if (total > 0) { el.textContent = total; el.style.display = 'inline'; }
  else el.style.display = 'none';
}

/* ‚ïê‚ïê END NEW FEATURES ‚ïê‚ïê */

const expose={doLogin,doRegister,sendMsg,logoutUser,filterC,openMenu,closeMenu,openSettings,openMyProfile,openUserProfile,cm2,confirmDelChat,delChat,showOnlineUsers,trigFile,sendFile,showSc,sv,changeAvatar,toggleOnlineSt,previewImg,closeImgPrev,downloadCurrentImg,clearReply,clearFwd,clearPin,scrollToPin,scrollToBottom,toggleChatSearch,closeChatSearch,searchMsgs,navSearch,addReaction,addReactionCtx,setReply,pinMsg,exportChat,startVoiceRec,stopVoiceRec,cancelVoice,sendVoice,playVoice,openHardPlus,activateHardPlus,setTheme,openStickers,sendSticker,openGif,searchGif,sendGif,openChatStats,applyUserTitle,clearUserTitle,setTitleColor,applyStatusText,quickStatus,goBack,openChatAct,closeChatAct,toggleSelfDestruct,hideCxbs,insertFmt,toggleFmtBar,openEmojiPicker,openBookmarks,bookmarkMsg,setFontSize,showFwdModal,startEdit,cancelEdit,toggleTpl,useTpl,scrollToTop,rollDice,openGallery,openMuteModal,muteChatFor,clearSearch,focusSearch,onSearch,toggleStar,saveDraft,openCreateGroup,createGroupOrChannel,setGcType,openGroupInfo,addMemberToGroup,kickMember,leaveGroup,sendGroupMsg,addGroupReaction,togglePinChat,quickDeleteChat,showChatCtx,closeChatCtx,openGroupInfoDirect,openMuteModalFor};


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   –ì–†–£–ü–ü–´ –ò –ö–ê–ù–ê–õ–´ ‚Äî HARD Messenger
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let gcType = 'group'; // 'group' | 'channel'
let selectedGroupMembers = new Set();

function setGcType(t){
  gcType = t;
  document.getElementById('gcTabGrp').classList.toggle('on', t==='group');
  document.getElementById('gcTabChn').classList.toggle('on', t==='channel');
  document.getElementById('gcMembersWrap').style.display = t==='channel' ? 'none' : '';
}

async function openCreateGroup(){
  gcType = 'group';
  selectedGroupMembers = new Set();
  setGcType('group');
  document.getElementById('gcName').value = '';
  // Fill member list from allC
  const list = document.getElementById('gcMemberList');
  list.innerHTML = '';
  const users = allC.length ? allC : [];
  if(!users.length){
    // Load from DB if needed
    const sn = await get(ref(db,'users'));
    if(sn.exists()) for(let id in sn.val()) if(id!==CU.id) users.push({id,...sn.val()[id]});
  }
  users.forEach(u => {
    const row = document.createElement('label');
    row.className = 'gc-member';
    row.innerHTML = `<input type="checkbox" value="${u.id}"><img src="${u.avatar||defAva(u.username)}" onerror="this.src='${defAva(u.username)}'"><span class="gm-name">${eh(u.username)}</span>`;
    row.querySelector('input').addEventListener('change', e => {
      if(e.target.checked) selectedGroupMembers.add(u.id);
      else selectedGroupMembers.delete(u.id);
    });
    list.appendChild(row);
  });
  om2('gcMo');
}

async function createGroupOrChannel(){
  const name = document.getElementById('gcName').value.trim();
  if(!name) return toast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ','err');
  if(gcType==='group' && selectedGroupMembers.size===0) return toast('–í—ã–±–µ—Ä–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞','err');

  const members = {};
  members[CU.id] = 'admin';
  if(gcType==='group') selectedGroupMembers.forEach(id => members[id] = 'member');

  const groupData = {
    name,
    type: gcType,
    avatar: '',
    createdBy: CU.id,
    createdAt: Date.now(),
    members,
  };

  try{
    const newRef = await push(ref(db, gcType==='group' ? 'groups' : 'channels'), groupData);
    cm2('gcMo');
    toast(`‚úì ${gcType==='group'?'–ì—Ä—É–ø–ø–∞':'–ö–∞–Ω–∞–ª'} —Å–æ–∑–¥–∞–Ω!`, 'ok');
    // Open the new group/channel chat
    const gc = {id: newRef.key, ...groupData, isGroup: gcType==='group', isChannel: gcType==='channel'};
    openGroupChat(gc);
  }catch(e){
    toast('–û—à–∏–±–∫–∞: '+e.message,'err');
  }
}

/* ‚îÄ‚îÄ Open group/channel chat ‚îÄ‚îÄ */
function openGroupChat(gc){
  CC = gc;
  if(msgUnsub){msgUnsub();msgUnsub=null;}
  if(stUnsub){stUnsub();stUnsub=null;}

  document.getElementById('es').style.display='none';
  const ca = document.getElementById('ca');
  ca.classList.add('on');

  const ava = gc.avatar || defAvaGroup(gc.name, gc.isChannel);
  document.getElementById('chav').src = ava;
  const memberCount = Object.keys(gc.members||{}).length;
  document.getElementById('chn').textContent = gc.name;
  document.getElementById('chs').innerHTML = gc.isChannel
    ? `<span style="color:#ba68c8">üì¢ –ö–∞–Ω–∞–ª</span> ¬∑ ${memberCount} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤`
    : `<span style="color:#42a5f5">üë• –ì—Ä—É–ø–ø–∞</span> ¬∑ ${memberCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;

  // Show group info button, hide user profile button
  const grpBtn = document.getElementById('grpInfoBtn');
  if(grpBtn) grpBtn.style.display = '';

  document.querySelectorAll('.ci').forEach(el=>el.classList.toggle('active', el.dataset.id===gc.id));
  clearReply(); clearPin(); closeChatSearch();

  const mi = document.getElementById('mi');
  // Channels: only admins can write
  if(gc.isChannel && gc.members[CU.id] !== 'admin'){
    mi.disabled = true;
    mi.placeholder = 'üì¢ –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å';
    document.querySelector('.sbtn').style.opacity = '0.3';
    document.querySelector('.sbtn').style.pointerEvents = 'none';
  } else {
    mi.disabled = false;
    mi.placeholder = '–°–æ–æ–±—â–µ–Ω–∏–µ...';
    document.querySelector('.sbtn').style.opacity = '';
    document.querySelector('.sbtn').style.pointerEvents = '';
  }

  loadGroupMsgs(gc);

  // Listen for member updates
  stUnsub = onValue(ref(db, `${gc.isChannel?'channels':'groups'}/${gc.id}/members`), sn => {
    if(!sn.exists()) return;
    CC.members = sn.val();
    const cnt = Object.keys(CC.members).length;
    document.getElementById('chs').innerHTML = gc.isChannel
      ? `<span style="color:#ba68c8">üì¢ –ö–∞–Ω–∞–ª</span> ¬∑ ${cnt} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤`
      : `<span style="color:#42a5f5">üë• –ì—Ä—É–ø–ø–∞</span> ¬∑ ${cnt} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
  });
  document.getElementById('mi').focus();
}

function defAvaGroup(name, isChannel){
  const l = (name||'?')[0].toUpperCase();
  const color = isChannel ? '%239c27b0' : '%231e88e5';
  const radius = isChannel ? '4' : '25';
  return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 50'%3E%3Crect width='50' height='50' rx='${radius}' fill='%23141414'/%3E%3Ctext x='25' y='33' text-anchor='middle' font-size='22' fill='${color}' font-family='IBM+Plex+Mono'%3E${encodeURIComponent(l)}%3C/text%3E%3C/svg%3E`;
}

function loadGroupMsgs(gc){
  const ma = document.getElementById('ma');
  ma.innerHTML = '<div style="text-align:center;color:var(--txt3);padding:28px;font-size:12px;font-family:IBM Plex Mono,monospace;">–∑–∞–≥—Ä—É–∑–∫–∞...</div>';
  const path = gc.isChannel ? `channelMsgs/${gc.id}` : `groupMsgs/${gc.id}`;
  let lastD = null;
  msgUnsub = onValue(ref(db, path), sn => {
    const atBottom = ma.scrollHeight - ma.scrollTop - ma.clientHeight < 100;
    ma.innerHTML = ''; lastD = null;
    if(!sn.exists()){
      ma.innerHTML = emptyChat(gc.name);
      return;
    }
    const msgs = [];
    const all = sn.val();
    for(let id in all) msgs.push({id, ...all[id]});
    msgs.sort((a,b) => a.timestamp - b.timestamp);
    msgs.forEach(m => {
      const d = new Date(m.timestamp).toDateString();
      if(d !== lastD){
        lastD = d;
        const dd = document.createElement('div');
        dd.className = 'dd';
        dd.innerHTML = `<span>${new Date(m.timestamp).toLocaleDateString('ru-RU',{day:'numeric',month:'long'})}</span>`;
        ma.appendChild(dd);
      }
      ma.appendChild(buildGroupMsg(m, gc));
    });
    if(atBottom || msgs.length <= 3) ma.scrollTop = ma.scrollHeight;
  });
}

function buildGroupMsg(m, gc){
  const out = m.from === CU.id;
  const sender = allUsers[m.from] || {};
  const w = document.createElement('div');
  w.className = `mw ${out?'out':'in'}`;
  w.dataset.mid = m.id;

  // Quick reaction picker
  const qa = document.createElement('div');
  qa.className = 'qact';
  const REACT = ['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üî•'];
  qa.innerHTML = REACT.map(e=>`<button class="qab" onclick="addGroupReaction('${m.id}','${e}','${gc.isChannel?'channels':'groups'}')">${e}</button>`).join('')
    + `<button class="qab" onclick="setReply('${m.id}','${(m.text||'').replace(/'/g,"&#39;").substring(0,80)}','${out?'–í—ã':eh(sender.username||'?')}')">‚Ü©</button>`;
  w.appendChild(qa);

  const mb = document.createElement('div');
  mb.className = 'mb';
  mb.id = 'mb_' + m.id;
  let cnt = '';

  // Show sender name for incoming in group
  if(!out){
    const senderName = sender.username || '?';
    const senderColor = '#' + ((parseInt(m.from.substring(0,6),16)||0)%0xffffff).toString(16).padStart(6,'0').replace(/^0+$/,'42a5f5');
    cnt += `<div style="font-size:10px;font-weight:600;margin-bottom:3px;font-family:IBM Plex Mono,monospace;color:#42a5f5;">${eh(senderName)}</div>`;
  }
  if(m.replyText) cnt += `<div class="mb-quote"><div class="qn">${eh(m.replyFrom||'')}</div>${eh(m.replyText.substring(0,80))}</div>`;
  if(m.type==='image') cnt += `<img class="msg-img" src="${m.imageData}" onclick="previewImg('${m.imageData}')">`;
  else cnt += parseText(m.text||'') + (m.edited?` <span class="edit-tag">(—Ä–µ–¥.)</span>`:'');

  mb.innerHTML = cnt;
  w.appendChild(mb);

  const mm = document.createElement('div');
  mm.className = 'mm';
  mm.innerHTML = ft(m.timestamp) + (out ? (m.read?` <span class="ri r">‚úì‚úì</span>`:` <span class="ri">‚úì</span>`) : '');
  w.appendChild(mm);

  // Reactions
  if(m.reactions && Object.keys(m.reactions).length){
    const rrow = document.createElement('div');
    rrow.className = 'react-row';
    const counts = {};
    for(let uid in m.reactions){ const e=m.reactions[uid]; counts[e]=(counts[e]||0)+1; }
    for(let em in counts){
      const mine = m.reactions[CU.id]===em;
      const pill = document.createElement('div');
      pill.className = 'rpill'+(mine?' mine':'');
      pill.innerHTML = `${em}<span class="rc">${counts[em]}</span>`;
      const path = gc.isChannel ? 'channels' : 'groups';
      pill.onclick = () => addGroupReaction(m.id, em, path);
      rrow.appendChild(pill);
    }
    w.appendChild(rrow);
  }

  w.addEventListener('contextmenu', e => {
    e.preventDefault();
    // Simple: only delete own
    if(out){ const doDelete = confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?'); if(doDelete) deleteGroupMsg(m.id, gc); }
  });
  return w;
}

async function deleteGroupMsg(msgId, gc){
  const path = gc.isChannel ? `channelMsgs/${gc.id}/${msgId}` : `groupMsgs/${gc.id}/${msgId}`;
  try{ await remove(ref(db, path)); toast('‚úì –£–¥–∞–ª–µ–Ω–æ','ok'); }catch(e){ toast('–û—à–∏–±–∫–∞','err'); }
}

async function sendGroupMsg(){
  if(!CC || (!CC.isGroup && !CC.isChannel)) return;
  if(CC.isChannel && CC.members[CU.id] !== 'admin') return;
  const inp = document.getElementById('mi');
  const txt = inp.value.trim();
  if(!txt) return;
  inp.value = ''; inp.style.height = 'auto';
  const path = CC.isChannel ? `channelMsgs/${CC.id}` : `groupMsgs/${CC.id}`;
  const msg = {from:CU.id, text:txt, timestamp:Date.now()};
  if(replyTo){ msg.replyText=replyTo.text.substring(0,80); msg.replyFrom=replyTo.from; }
  clearReply();
  try{ await push(ref(db, path), msg); if(S.sound) playBeep(); }catch(e){ toast('–û—à–∏–±–∫–∞','err'); }
}

async function addGroupReaction(msgId, emoji, collectionPath){
  if(!CU || !CC) return;
  const path = collectionPath==='channels' ? `channelMsgs/${CC.id}/${msgId}/reactions/${CU.id}` : `groupMsgs/${CC.id}/${msgId}/reactions/${CU.id}`;
  try{
    const sn = await get(ref(db, path));
    if(sn.exists() && sn.val()===emoji) await remove(ref(db, path));
    else await update(ref(db, path.replace('/'+CU.id,'')), {[CU.id]:emoji});
  }catch(e){}
}

/* ‚îÄ‚îÄ Group Info Modal ‚îÄ‚îÄ */
async function openGroupInfo(){
  if(!CC || (!CC.isGroup && !CC.isChannel)) return;
  document.getElementById('grpInfoAva').src = CC.avatar || defAvaGroup(CC.name, CC.isChannel);
  document.getElementById('grpInfoName').textContent = CC.name;
  document.getElementById('grpInfoType').textContent = CC.isChannel ? 'üì¢ –ö–∞–Ω–∞–ª' : 'üë• –ì—Ä—É–ø–ø–∞';

  const isAdmin = CC.members[CU.id] === 'admin';
  document.getElementById('grpLeaveBtn').textContent = isAdmin ? 'üóë –£–¥–∞–ª–∏—Ç—å' : 'üö™ –ü–æ–∫–∏–Ω—É—Ç—å';

  // Fill members list
  const ml = document.getElementById('grpMembersList');
  ml.innerHTML = '';
  for(let uid in CC.members){
    const role = CC.members[uid];
    const u = allUsers[uid] || {};
    const row = document.createElement('div');
    row.className = 'grp-member-row';
    row.innerHTML = `<img src="${u.avatar||defAva(u.username||'?')}" onerror="this.src='${defAva('?')}'"><div style="flex:1;"><div style="font-size:13px;font-weight:500;">${eh(u.username||uid)}</div></div><span class="grp-member-role">${role==='admin'?'üëë admin':''}</span>`;
    if(isAdmin && uid !== CU.id){
      const kb = document.createElement('button');
      kb.className = 'grp-kick-btn';
      kb.textContent = '‚úï';
      kb.title = '–ò—Å–∫–ª—é—á–∏—Ç—å';
      kb.onclick = () => kickMember(uid);
      row.appendChild(kb);
    }
    ml.appendChild(row);
  }

  // Fill "add member" list
  const al = document.getElementById('grpAddList');
  al.innerHTML = '';
  if(isAdmin){
    const existingIds = new Set(Object.keys(CC.members));
    const candidates = allC.filter(u => !existingIds.has(u.id));
    candidates.forEach(u => {
      const row = document.createElement('div');
      row.className = 'gc-member';
      row.innerHTML = `<img src="${u.avatar||defAva(u.username)}" onerror="this.src='${defAva(u.username)}'"><span class="gm-name">${eh(u.username)}</span>`;
      const addBtn = document.createElement('button');
      addBtn.style.cssText = 'margin-left:auto;padding:4px 10px;background:var(--red);border:none;border-radius:6px;color:#fff;font-size:12px;cursor:pointer;';
      addBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å';
      addBtn.onclick = () => addMemberToGroup(u.id, u.username);
      row.appendChild(addBtn);
      al.appendChild(row);
    });
    if(!candidates.length) al.innerHTML = '<div style="color:var(--txt3);font-size:12px;padding:6px 0;">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–∂–µ –≤ –≥—Ä—É–ø–ø–µ</div>';
  } else {
    document.getElementById('grpAddWrap').style.display = 'none';
  }

  om2('grpInfoMo');
}

async function addMemberToGroup(uid, username){
  if(!CC || !CC.id) return;
  const path = CC.isChannel ? `channels/${CC.id}/members/${uid}` : `groups/${CC.id}/members/${uid}`;
  try{
    await set(ref(db, path), 'member');
    CC.members[uid] = 'member';
    toast(`‚úì ${username} –¥–æ–±–∞–≤–ª–µ–Ω`,'ok');
    openGroupInfo(); // refresh
  }catch(e){ toast('–û—à–∏–±–∫–∞','err'); }
}

async function kickMember(uid){
  if(!CC || !CC.id) return;
  const path = CC.isChannel ? `channels/${CC.id}/members/${uid}` : `groups/${CC.id}/members/${uid}`;
  try{
    await remove(ref(db, path));
    delete CC.members[uid];
    toast('‚úì –ò—Å–∫–ª—é—á—ë–Ω','ok');
    openGroupInfo();
  }catch(e){ toast('–û—à–∏–±–∫–∞','err'); }
}

async function leaveGroup(){
  if(!CC || !CC.id) return;
  const isAdmin = CC.members[CU.id] === 'admin';
  const path = CC.isChannel ? `channels/${CC.id}` : `groups/${CC.id}`;
  try{
    if(isAdmin){
      // Admin deletes the whole group
      await remove(ref(db, path));
      toast(`‚úì ${CC.isChannel?'–ö–∞–Ω–∞–ª':'–ì—Ä—É–ø–ø–∞'} —É–¥–∞–ª—ë–Ω`,'ok');
    } else {
      await remove(ref(db, `${path}/members/${CU.id}`));
      toast('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥—Ä—É–ø–ø—É','ok');
    }
    cm2('grpInfoMo');
    document.getElementById('es').style.display = '';
    document.getElementById('ca').classList.remove('on');
    if(msgUnsub){msgUnsub();msgUnsub=null;}
    CC = null;
  }catch(e){ toast('–û—à–∏–±–∫–∞','err'); }
}

/* ‚ïê‚ïê LOAD GROUPS+CHANNELS IN CONTACT LIST ‚ïê‚ïê */
function loadGroupsAndChannels(){
  // Listen to groups I'm a member of
  onValue(ref(db,'groups'), sn => {
    if(!sn.exists()) return;
    const all = sn.val();
    for(let id in all){
      const g = all[id];
      if(!g.members || !g.members[CU.id]) continue;
      // Add to contact list if not already there
      updateGroupInList(id, g, false);
    }
  });
  onValue(ref(db,'channels'), sn => {
    if(!sn.exists()) return;
    const all = sn.val();
    for(let id in all){
      const c = all[id];
      if(!c.members || !c.members[CU.id]) continue;
      updateGroupInList(id, c, true);
    }
  });
}

let groupContacts = []; // groups+channels I belong to
function updateGroupInList(id, data, isChannel){
  const existing = groupContacts.findIndex(g => g.id === id);
  const gc = {id, ...data, isGroup: !isChannel, isChannel};
  if(existing >= 0) groupContacts[existing] = gc;
  else groupContacts.push(gc);
  if(!searchMode) renderChats(chatContacts); // re-render with groups+GC
}

// Object.assign –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ –∫–æ–Ω–µ—Ü

// Loading —É–±—Ä–∞–Ω ‚Äî —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ DOMContentLoaded –≤–Ω–µ –º–æ–¥—É–ª—è

// Particles background
function initParticles(){
  // Simple CSS particles
  const body=document.body;
  for(let i=0;i<8;i++){
    const p=document.createElement('div');
    p.className='part';
    p.style.cssText=`left:${Math.random()*100}%;width:${Math.random()*3+1}px;height:${Math.random()*3+1}px;animation-duration:${Math.random()*20+10}s;animation-delay:${Math.random()*10}s;`;
    body.appendChild(p);
  }
}

function showSc(id){
  ['lw','rw'].forEach(s=>{const e=document.getElementById(s);if(e){e.style.display='none';e.classList.remove('on');}});
  document.getElementById('app').style.display='none';
  const t=document.getElementById(id);if(!t)return;t.style.display='flex';t.classList.add('on');
}
function showAlrt(id,msg,tp='err'){const e=document.getElementById(id);if(!e)return;e.textContent=msg;e.className=`alrt ${tp}`;e.style.display='block';setTimeout(()=>e.style.display='none',3800);}
function toast(msg,tp='info'){const d=document.createElement('div');d.className=`toast ${tp}`;d.textContent=msg;const tc=document.getElementById('tc');tc.appendChild(d);setTimeout(()=>{d.style.opacity='0';d.style.transition='opacity .3s';setTimeout(()=>d.remove(),300);},2800);}
function defAva(n){const l=(n||'?')[0].toUpperCase();return`data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 50'%3E%3Crect width='50' height='50' rx='25' fill='%23141414'/%3E%3Ctext x='25' y='33' text-anchor='middle' font-size='22' fill='%23e53935' font-family='IBM+Plex+Mono'%3E${encodeURIComponent(l)}%3C/text%3E%3C/svg%3E`;}
function ft(ts){if(!ts)return'';const d=new Date(ts),n=new Date();if(d.toDateString()===n.toDateString())return d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});if(new Date(n-86400000).toDateString()===d.toDateString())return'–í—á–µ—Ä–∞ '+d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});return d.toLocaleDateString('ru-RU',{day:'numeric',month:'short'});}
function eh(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function playBeep(){try{const c=new(window.AudioContext||window.webkitAudioContext)();const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=800;g.gain.value=.04;o.start();g.gain.exponentialRampToValueAtTime(.0001,c.currentTime+.12);setTimeout(()=>{o.stop();c.close();},170);}catch(e){}}
function cm2(id){document.getElementById(id)&&document.getElementById(id).classList.remove('on');}
function om2(id){document.getElementById(id)&&document.getElementById(id).classList.add('on');}

// Text formatting parser
function parseText(txt){
  if(!txt)return '';
  let html=eh(txt);
  // Code blocks first (multi-line)
  html=html.replace(/```([\s\S]*?)```/g,'<div class="msg-code-block">$1</div>');
  // Inline code
  html=html.replace(/`([^`]+)`/g,'<span class="msg-code">$1</span>');
  // Bold
  html=html.replace(/\*\*([^*]+)\*\*/g,'<span class="msg-bold">$1</span>');
  // Italic
  html=html.replace(/_([^_]+)_/g,'<span class="msg-italic">$1</span>');
  // Strike
  html=html.replace(/~~([^~]+)~~/g,'<span class="msg-strike">$1</span>');
  // Mentions
  html=parseMentions(html);
  // Newlines
  html=html.replace(/\n/g,'<br>');
  return html;
}

function getDisplayName(user){let name=eh(user.username||'');if(user.hardPlusTitle){const color=user.hardPlusTitleColor||'#f0b429';const bg=color+'22';name+=` <span class="user-title" style="color:${color};background:${bg};border:1px solid ${color}44;">${eh(user.hardPlusTitle)}</span>`;}return name;}

/* NAV */
function goBack(){
  // Save draft before leaving
  const mi = document.getElementById('mi');
  if(CC && mi) saveDraft(CC.id, mi.value);
  document.getElementById('viewChat').classList.remove('on');document.getElementById('viewList').style.display='flex';CC=null;if(msgUnsub){msgUnsub();msgUnsub=null;}if(stUnsub){stUnsub();stUnsub=null;}closeEmojiPicker();}
function openMenu(){om2('menuBS');}
function closeMenu(){cm2('menuBS');}
function openChatAct(){document.getElementById('sdActTxt').textContent=S.selfDestruct?'–°–∞–º–æ—É–¥–∞–ª–µ–Ω–∏–µ ON ‚úì':'–°–∞–º–æ—É–¥–∞–ª–µ–Ω–∏–µ OFF';om2('chatActBS');}
function closeChatAct(){cm2('chatActBS');}
function toggleSelfDestruct(){if(!S.hardPlus)return toast('–ù—É–∂–µ–Ω Hard+','err');sv('selfDestruct',!S.selfDestruct);toast(S.selfDestruct?'üí£ –°–∞–º–æ—É–¥–∞–ª–µ–Ω–∏–µ –≤–∫–ª':'–°–∞–º–æ—É–¥–∞–ª–µ–Ω–∏–µ –≤—ã–∫–ª',S.selfDestruct?'err':'ok');}
function openSettings(){om2('sp');}
function setFontSize(sz){sv('fontSize',sz);document.querySelectorAll('.mi2,.mb').forEach(el=>el.style.fontSize=sz+'px');}

/* EMOJI PICKER */
const EMOJI_CATS={
  'üòÄ':'üòÄüòÅüòÇü§£üòÉüòÑüòÖüòÜüòâüòäüòãüòéüòçü•∞üòòüòóüôÇü§óü§îüòêüòëüò∂üôÑüòèüò£üò•üòÆü§êüòØüò™üò´ü•±üò¥üòåüòõüòúüòùü§§üòíüòìüòîüòïüôÉü§ëüò≤üôÅüòñüòûüòüüò§üò¢üò≠üò¶üòßüò®üò©ü§Øüò¨üò∞üò±ü•µü•∂üò≥ü§™üòµüí´ü§†ü•≥ü•¥üò∑ü§íü§ïü§¢ü§Æü§ßü•∫üò¨ü•∂üëªüíÄ‚ò†Ô∏è',
  'üëç':'üëãü§öüñê‚úãüññüëåü§åü§è‚úåÔ∏èü§ûü§üü§òü§ôüëàüëâüëÜüñïüëá‚òùÔ∏èüëçüëé‚úäüëäü§õü§úüëèüôåü§≤ü§ùüôèüí™ü¶æü¶ø',
  '‚ù§Ô∏è':'‚ù§Ô∏èüß°üíõüíöüíôüíúüñ§ü§çü§é‚ù§Ô∏è‚Äçüî•üíî‚ù£Ô∏èüíïüíûüíìüíóüíñüíòüíù',
  'üî•':'üî•üí•‚ú®‚ö°üåüüí´‚≠êüåà‚òÄÔ∏èüåô‚õÖüåäüí®üå™Ô∏è‚ùÑÔ∏èüîÆüíéüí∞üèÜüéØ',
  'üêê':'üê∂üê±üê≠üêπüê∞ü¶äüêªüêºüê®üêØü¶ÅüêÆüê∑üê∏üêµüôàüôâüôäüê¶üêßü¶Üü¶Öü¶âü¶öü¶úüê∏üêäü¶ãüêùüêåü¶Äü¶ûü¶àüêô',
};
let currentEmojiCat='üòÄ';

function openEmojiPicker(){
  const picker=document.getElementById('emojiPicker');
  if(picker.classList.contains('on')){picker.classList.remove('on');return;}
  // Build cats
  const cats=document.getElementById('emojiCats');
  cats.innerHTML='';
  Object.keys(EMOJI_CATS).forEach(cat=>{
    const b=document.createElement('button');
    b.className='emoji-cat'+(cat===currentEmojiCat?' on':'');
    b.textContent=cat;
    b.onclick=()=>{currentEmojiCat=cat;document.querySelectorAll('.emoji-cat').forEach(c=>c.classList.remove('on'));b.classList.add('on');renderEmojis(cat);};
    cats.appendChild(b);
  });
  renderEmojis(currentEmojiCat);
  picker.classList.add('on');
}
function closeEmojiPicker(){document.getElementById('emojiPicker').classList.remove('on');}
function renderEmojis(cat){
  const grid=document.getElementById('emojiGrid');
  grid.innerHTML='';
  const emojis=[...EMOJI_CATS[cat]].filter(c=>c.trim());
  emojis.forEach(e=>{
    const b=document.createElement('button');
    b.className='emoji-btn';
    b.textContent=e;
    b.onclick=()=>{const mi=document.getElementById('mi');mi.value+=e;mi.focus();};
    grid.appendChild(b);
  });
}
document.addEventListener('touchstart',e=>{
  if(!e.target.closest('#emojiPicker')&&!e.target.closest('.abtn'))closeEmojiPicker();
},{passive:true});

/* TEXT FORMATTING */
function toggleFmtBar(){const fb=document.getElementById('fmtBar');fb.classList.toggle('on');if(fb.classList.contains('on'))toast('‚úçÔ∏è –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: **–∂–∏—Ä–Ω—ã–π** _–∫—É—Ä—Å–∏–≤_ ~~–∑–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π~~ `–∫–æ–¥`','info');}
function insertFmt(pre,post){
  const mi=document.getElementById('mi');
  const s=mi.selectionStart,e=mi.selectionEnd;
  const sel=mi.value.substring(s,e)||'—Ç–µ–∫—Å—Ç';
  mi.value=mi.value.substring(0,s)+pre+sel+post+mi.value.substring(e);
  mi.focus();
  mi.selectionStart=s+pre.length;
  mi.selectionEnd=s+pre.length+sel.length;
}

/* AUTH */
async function doRegister(){
  const u=document.getElementById('ru').value.trim(),p=document.getElementById('rp').value,p2=document.getElementById('rp2').value;
  if(u.length<3)return showAlrt('re','–ò–º—è –º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞');if(p.length<6)return showAlrt('re','–ü–∞—Ä–æ–ª—å –º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤');if(p!==p2)return showAlrt('re','–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
  const btn=document.getElementById('rbtn');btn.disabled=true;btn.textContent='...';
  try{
    const sn=await get(ref(db,'users'));
    if(sn.exists())for(let id in sn.val())if(sn.val()[id].username.toLowerCase()===u.toLowerCase()){showAlrt('re','–ò–º—è –∑–∞–Ω—è—Ç–æ');btn.disabled=false;btn.textContent='–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';return;}
    await set(push(ref(db,'users')),{username:u,password:p,avatar:defAva(u),createdAt:Date.now(),online:false,lastSeen:Date.now()});
    showAlrt('ro','–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!','ok');['ru','rp','rp2'].forEach(id=>document.getElementById(id).value='');setTimeout(()=>showSc('lw'),1300);
  }catch(e){showAlrt('re','–û—à–∏–±–∫–∞: '+e.message);}
  btn.disabled=false;btn.textContent='–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
}
async function doLogin(){
  const u=document.getElementById('lu').value.trim(),p=document.getElementById('lp').value;
  if(!u||!p)return showAlrt('le','–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
  const btn=document.getElementById('lbtn');btn.disabled=true;btn.textContent='...';
  try{
    const sn=await get(ref(db,'users'));if(!sn.exists()){showAlrt('le','–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');btn.disabled=false;btn.textContent='–í–æ–π—Ç–∏';return;}
    const us=sn.val();let fu=null,fid=null;
    for(let id in us)if(us[id].username.toLowerCase()===u.toLowerCase()&&us[id].password===p){fu=us[id];fid=id;break;}
    if(!fu){showAlrt('le','–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');btn.disabled=false;btn.textContent='–í–æ–π—Ç–∏';return;}
    CU={id:fid,...fu};
    await update(ref(db,`users/${fid}`),{online:true,lastSeen:Date.now()});
    onDisconnect(ref(db,`users/${fid}/online`)).set(false);
    onDisconnect(ref(db,`users/${fid}/lastSeen`)).set(Date.now());
    ['lu','lp'].forEach(id=>document.getElementById(id).value='');
    initMessenger();
  }catch(e){showAlrt('le','–û—à–∏–±–∫–∞: '+e.message);}
  btn.disabled=false;btn.textContent='–í–æ–π—Ç–∏';
}
function initMessenger(){
  ['lw','rw'].forEach(id=>{const e=document.getElementById(id);if(e){e.style.display='none';e.classList.remove('on');}});
  document.getElementById('app').style.display='flex';
  document.getElementById('topAva').src=CU.avatar||defAva(CU.username);
  document.getElementById('sndT').checked=S.sound!==false;
  document.getElementById('onlT').checked=S.onlineStatus!==false;
  if(S.theme&&S.theme!=='default')setTheme(S.theme);
  if(S.hardPlus){document.getElementById('menuHPBadge').style.display='';}
  if(S.fontSize)document.querySelectorAll('.mi2,.mb').forEach(el=>el.style.fontSize=S.fontSize+'px');
  if(S.rounded===false)document.documentElement.style.setProperty('--msg-radius','8px');
  loadContacts();loadGroupsAndChannels();
  // Request notification permission
  if('Notification' in window&&Notification.permission==='default')Notification.requestPermission();
}
function sv(k,v){S[k]=v;localStorage.setItem('hard_s',JSON.stringify(S));}
function previewImg(src){document.getElementById('ipimg').src=src;document.getElementById('ipdown').dataset.src=src;om2('ipov');}
function closeImgPrev(){cm2('ipov');}
function downloadCurrentImg(){const src=document.getElementById('ipdown').dataset.src;if(!src)return;const a=document.createElement('a');a.href=src;a.download='hard_img_'+Date.now()+'.jpg';a.click();}
function trigFile(){document.getElementById('fatt').click();}

// Online counter
function updateOnlineCount(users){
  let cnt=0;
  for(let id in users)if(users[id].online&&id!==CU?.id)cnt++;
  document.getElementById('onlineNum').textContent=cnt;
}

/* CONTACTS */

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTACTS / CHATS LOGIC v4.2 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// allC = all users from DB (for lookup/mention autocomplete)
// chatContacts = users I actually have messages with (shown in list)
let chatContacts = [];
let allUsers = {}; // id -> user obj
let searchMode = false;

function loadContacts(){
  if(cUnsub)cUnsub();
  // Listen to ALL messages to determine who I chatted with
  // Also listen to users for online status updates
  let usersUnsub = onValue(ref(db,'users'), sn => {
    if(!sn.exists()) return;
    allUsers = sn.val();
    updateOnlineCount(allUsers);
    // rebuild allC for other functionality
    allC = [];
    for(let id in allUsers) if(id !== CU.id) allC.push({id, ...allUsers[id]});
    // Refresh chat contacts online status without full reload
    chatContacts = chatContacts.map(c => {
      const u = allUsers[c.id];
      return u ? {...c, ...u, id:c.id} : c;
    });
    if(!searchMode) renderChats(chatContacts);
    if(CC){const upd=allC.find(c=>c.id===CC.id);if(upd){CC={...CC,...upd};updSt(CC);}}
  });

  // Listen to messages to build chat list
  cUnsub = onValue(ref(db,'messages'), sn => {
    // Build set of user IDs I've chatted with
    const chatMap = {}; // uid -> {lastMsg, unreadCount}
    if(sn.exists()){
      const msgs = sn.val();
      for(let id in msgs){
        const m = msgs[id];
        const isMe = m.from === CU.id;
        const other = isMe ? m.to : m.from;
        if(m.from !== CU.id && m.to !== CU.id) continue; // not my message
        if(other === CU.id) continue;
        if(!chatMap[other] || m.timestamp > chatMap[other].lastMsg.timestamp){
          chatMap[other] = { lastMsg: {id, ...m}, unread: 0 };
        }
        // Count unread (from them, not read)
        if(!isMe && !m.read) chatMap[other].unread = (chatMap[other].unread||0)+1;
      }
      // Re-count unread properly (single pass)
      for(let id in msgs){
        const m = msgs[id];
        if(m.from !== CU.id && m.to === CU.id && !m.read){
          if(!chatMap[m.from]) chatMap[m.from] = {lastMsg:{id,...m}, unread:0};
          // unread already counted above
        }
      }
    }

    // Build chatContacts list
    chatContacts = [];
    for(let uid in chatMap){
      const u = allUsers[uid] || {};
      const last = chatMap[uid].lastMsg;
      contactLastMsgCache[uid] = last;
      // count actual unread
      let ur = 0;
      if(sn.exists()){const ms=sn.val();for(let id in ms){const m=ms[id];if(m.from===uid&&m.to===CU.id&&!m.read)ur++;}}
      unread[uid] = ur;
      chatContacts.push({id:uid, ...u, _lastMsg:last, _lastTs: last.timestamp||0});
    }

    // Sort by last message timestamp (newest first)
    chatContacts.sort((a,b) => b._lastTs - a._lastTs);

    refreshUnreadBadge();
    if(!searchMode) renderChats(chatContacts);
  });

  // Store combined unsub
  const _origUnsub = cUnsub;
  cUnsub = () => { _origUnsub(); usersUnsub(); };
}

function renderChats(contacts){
  const cl = document.getElementById('cl');

  // Merge –ª–∏—á–Ω—ã–µ —á–∞—Ç—ã + –≥—Ä—É–ø–ø—ã/–∫–∞–Ω–∞–ª—ã
  const all = [
    ...contacts,
    ...groupContacts.map(g=>({...g, _isGCItem:true}))
  ];

  if(!all.length){
    cl.innerHTML = `<div class="nc-empty">
      <span class="nc-ic">üí¨</span>
      <div class="nc-t">–ù–µ—Ç —á–∞—Ç–æ–≤</div>
      <div class="nc-s">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É <b>‚úé</b> –∏–ª–∏ –Ω–∞–π–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</div>
      <button class="nc-btn" onclick="focusSearch()">–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    </div>`;
    return;
  }
  cl.innerHTML='';

  // –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ
  const pinned  = all.filter(c => pinnedChats.includes(c.id));
  const rest    = all.filter(c => !pinnedChats.includes(c.id));

  // –°—Ä–µ–¥–∏ –Ω–µ–∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö ‚Äî –∏–∑–±—Ä–∞–Ω–Ω—ã–µ
  const starred = rest.filter(c => !c._isGCItem && starredContacts.includes(c.id));
  const regular = rest.filter(c => c._isGCItem || !starredContacts.includes(c.id));

  if(pinned.length){
    const sec = document.createElement('div');
    sec.className = 'cl-section';
    sec.textContent = 'üìå –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ';
    cl.appendChild(sec);
    pinned.forEach(c => cl.appendChild(c._isGCItem ? buildGCItem(c) : buildContactItem(c)));
  }

  if(starred.length){
    const sec = document.createElement('div');
    sec.className = 'cl-section';
    sec.textContent = '‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ';
    cl.appendChild(sec);
    starred.forEach(c => cl.appendChild(buildContactItem(c)));
  }

  if(regular.length){
    if(starred.length || pinned.length){
      const sec2 = document.createElement('div');
      sec2.className = 'cl-section';
      sec2.textContent = 'üí¨ –ß–∞—Ç—ã';
      cl.appendChild(sec2);
    }
    regular.forEach(c => cl.appendChild(c._isGCItem ? buildGCItem(c) : buildContactItem(c)));
  }

  updateTitleUnread();
}

// ‚îÄ‚îÄ –≠–ª–µ–º–µ–Ω—Ç –≥—Ä—É–ø–ø—ã/–∫–∞–Ω–∞–ª–∞ –≤ —Å–ø–∏—Å–∫–µ ‚îÄ‚îÄ
function buildGCItem(gc){
  const div = document.createElement('div');
  div.className = 'ci';
  const isPinned = pinnedChats.includes(gc.id);
  const isAdmin = gc.members && gc.members[CU.id]==='admin';
  const memberCount = gc.members ? Object.keys(gc.members).length : 0;
  div.innerHTML = `
    <div class="caw"><img class="ca" src="${gc.avatar||defAvaGroup(gc.name,gc.isChannel)}" onerror="this.src='${defAvaGroup(gc.name,gc.isChannel)}'"></div>
    <div class="cb">
      <div class="ct">
        <div class="cn">${gc.isChannel?'üì¢ ':'üë• '}${eh(gc.name||'')}${isAdmin?'<span style="font-size:10px;color:var(--red);margin-left:4px;">admin</span>':''}</div>
        <div class="ctm">${memberCount} —É—á.</div>
      </div>
      <div class="cbo">
        <div class="clm" style="color:var(--txt3);font-style:italic;">${gc.isChannel?'–ö–∞–Ω–∞–ª':'–ì—Ä—É–ø–ø–∞'}</div>
      </div>
    </div>`;
  div.onclick = () => openGroupChat(gc);
  div.addEventListener('contextmenu', e => showChatCtx(e, gc));
  let _ltTimer;
  div.addEventListener('touchstart', ()=>{ _ltTimer=setTimeout(()=>{ const evt={clientX:div.getBoundingClientRect().left+10,clientY:div.getBoundingClientRect().top+10,preventDefault:()=>{},stopPropagation:()=>{}}; showChatCtx(evt,gc); },500); },{passive:true});
  div.addEventListener('touchend', ()=>clearTimeout(_ltTimer),{passive:true});
  div.addEventListener('touchmove', ()=>clearTimeout(_ltTimer),{passive:true});
  return div;
}

function buildContactItem(c){
  const ur = unread[c.id]||0;
  const last = c._lastMsg;
  const muted = (mutedChats[c.id]||0) > Date.now() || mutedChats[c.id]===-1;
  const isStarred = starredContacts.includes(c.id);
  const draft = drafts[c.id];
  const div = document.createElement('div');
  div.className = 'ci' + (isStarred?' starred':'');
  div.dataset.id = c.id;

  let lastContent = '';
  if(draft){
    lastContent = `<span class="draft-pfx">—á–µ—Ä–Ω–æ–≤–∏–∫:</span>${eh(draft.substring(0,25))}`;
  } else if(last){
    const pfx = last.from===CU.id ? '–≤—ã: ' : '';
    lastContent = pfx + previewMsgText(last);
  } else if(c.statusText){
    lastContent = `<span style="font-style:italic;color:var(--txt3)">${eh(c.statusText.substring(0,25))}</span>`;
  }

  const lastTs  = last ? ft(last.timestamp) : '';
  const tick    = last && last.from===CU.id ? `<span class="tick ${last.read?'read':'sent'}">${last.read?'‚úì‚úì':'‚úì'}</span>` : '';

  div.innerHTML = `
    <div class="caw"><img class="ca ${c.online?'has-story':''}" src="${c.avatar||defAva(c.username)}" onerror="this.src='${defAva(c.username)}'">${c.online?'<div class="cod"></div>':''}</div>
    <div class="cb">
      <div class="ct">
        <div class="cn">${getDisplayName(c)}${muted?'<span class="muted-ic">üîï</span>':''}</div>
        <div class="ctm">${tick} ${lastTs}</div>
      </div>
      <div class="cbo">
        <div class="clm">${lastContent}</div>
        <div style="display:flex;align-items:center;gap:4px;">
          ${ur?`<div class="ubadge${muted?' muted':''}">${ur}</div>`:''}
          <button class="star-btn${isStarred?' on':''}" onclick="event.stopPropagation();toggleStar('${c.id}')">${isStarred?'‚≠ê':'‚òÜ'}</button>
        </div>
      </div>
    </div>`;
  div.onclick = () => openChat(c);
  div.addEventListener('contextmenu', e => showChatCtx(e, c));
  // –î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –º–æ–±–∏–ª–µ
  let _ltTimer;
  div.addEventListener('touchstart', ()=>{ _ltTimer=setTimeout(()=>{ const evt={clientX:div.getBoundingClientRect().left+10,clientY:div.getBoundingClientRect().top+10,preventDefault:()=>{},stopPropagation:()=>{}}; showChatCtx(evt,c); },500); },{passive:true});
  div.addEventListener('touchend', ()=>clearTimeout(_ltTimer), {passive:true});
  div.addEventListener('touchmove', ()=>clearTimeout(_ltTimer), {passive:true});
  return div;
}

// Search: unified ‚Äî shows matching chats + matching global users simultaneously
async function onSearch(q){
  const clearBtn = document.getElementById('siClear');
  const hint = document.getElementById('searchHint');
  if(clearBtn) clearBtn.classList.toggle('on', q.length > 0);

  if(!q){
    searchMode = false;
    if(hint) hint.style.display='none';
    renderChats(chatContacts);
    return;
  }

  searchMode = true;
  const ql = q.toLowerCase();

  // If allC not loaded yet ‚Äî load it now from Firebase
  if(allC.length === 0){
    try{
      const sn = await get(ref(db,'users'));
      if(sn.exists()){
        allUsers = sn.val();
        allC = [];
        for(let id in allUsers) if(id !== CU.id) allC.push({id, ...allUsers[id]});
      }
    }catch(e){ console.error('Failed to load users for search', e); }
  }

  // Matching existing chats
  const matchChats = chatContacts.filter(c => (c.username||'').toLowerCase().includes(ql));

  // Matching ALL users not already in matchChats
  const chatIds = new Set(matchChats.map(c=>c.id));
  const matchNew = allC.filter(c => (c.username||'').toLowerCase().includes(ql) && !chatIds.has(c.id));

  const total = matchChats.length + matchNew.length;
  if(hint){
    hint.style.display = 'block';
    hint.textContent = total ? `–Ω–∞–π–¥–µ–Ω–æ: ${total} (${matchChats.length} —á–∞—Ç${matchChats.length!==1?'–æ–≤':''} ¬∑ ${matchNew.length} –Ω–æ–≤—ã—Ö)` : '–Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
  }

  renderUnifiedSearch(matchChats, matchNew, q);
}

function renderUnifiedSearch(chats, newUsers, q){
  const cl = document.getElementById('cl');
  cl.innerHTML = '';

  if(!chats.length && !newUsers.length){
    cl.innerHTML = `<div class="nc-empty">
      <span class="nc-ic">üîç</span>
      <div class="nc-t">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
      <div class="nc-s">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ¬´${eh(q)}¬ª –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</div>
    </div>`;
    return;
  }

  // Section: –ú–æ–∏ —á–∞—Ç—ã
  if(chats.length){
    const sec = document.createElement('div');
    sec.className = 'cl-section';
    sec.textContent = 'üí¨ –ú–æ–∏ —á–∞—Ç—ã';
    cl.appendChild(sec);
    chats.forEach(c => {
      const ur = unread[c.id]||0;
      const last = c._lastMsg;
      const div = document.createElement('div');
      div.className = 'ci';
      const lastTxt = last ? previewMsgText(last) : '';
      const lastPfx = last && last.from===CU.id ? '–≤—ã: ' : '';
      const lastTs  = last ? ft(last.timestamp) : '';
      const tick    = last && last.from===CU.id ? `<span class="tick ${last.read?'read':'sent'}">${last.read?'‚úì‚úì':'‚úì'}</span>` : '';
      div.innerHTML = `
        <div class="caw"><img class="ca ${c.online?'has-story':''}" src="${c.avatar||defAva(c.username)}" onerror="this.src='${defAva(c.username)}'">${c.online?'<div class="cod"></div>':''}</div>
        <div class="cb">
          <div class="ct">
            <div class="cn">${getDisplayName(c)}</div>
            <div class="ctm">${tick} ${lastTs}</div>
          </div>
          <div class="cbo">
            <div class="clm">${lastPfx}${lastTxt}</div>
            ${ur?`<div class="ubadge">${ur}</div>`:''}
          </div>
        </div>`;
      div.onclick = () => { clearSearch(); openChat(c); };
      cl.appendChild(div);
    });
  }

  // Section: –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (new)
  if(newUsers.length){
    const sec2 = document.createElement('div');
    sec2.className = 'cl-section';
    sec2.textContent = 'üîé –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –±–∞–∑–µ';
    cl.appendChild(sec2);
    newUsers.forEach(c => {
      const div = document.createElement('div');
      div.className = 'ci search-result';
      div.innerHTML = `
        <div class="caw"><img class="ca" src="${c.avatar||defAva(c.username)}" onerror="this.src='${defAva(c.username)}'">${c.online?'<div class="cod"></div>':''}</div>
        <div class="cb">
          <div class="ct"><div class="cn">${getDisplayName(c)}</div><div class="ctm" style="color:var(--red-l);font-size:10px;">–ù–æ–≤—ã–π —á–∞—Ç</div></div>
          <div class="cbo"><div class="clm" style="color:var(--txt3);">@${eh(c.username)} ${c.online?'¬∑ <span style="color:var(--green)">–æ–Ω–ª–∞–π–Ω</span>':''}</div></div>
        </div>`;
      div.onclick = () => { clearSearch(); openChat(c); };
      cl.appendChild(div);
    });
  }
}

function onSearchFocus(){ /* show hint */ }
function onSearchBlur(){ /* delayed hide */ }
function focusSearch(){
  const si = document.getElementById('si');
  si.focus();
  si.placeholder = '–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É...';
}
function clearSearch(){
  const si = document.getElementById('si');
  si.value = '';
  si.placeholder = '–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É...';
  const clearBtn = document.getElementById('siClear');
  if(clearBtn) clearBtn.classList.remove('on');
  const hint = document.getElementById('searchHint');
  if(hint) hint.style.display='none';
  searchMode = false;
  renderChats(chatContacts);
}

function previewMsgText(m){return m.type==='image'?'üì∑ –§–æ—Ç–æ':m.type==='file'?`üìÑ ${eh(m.fileName||'')}`:m.type==='voice'?'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ':m.type==='sticker'?`${m.stickerEmoji||'üé≠'} —Å—Ç–∏–∫–µ—Ä`:m.type==='gif'?'üé¨ GIF':m.type==='dice'?`üé≤ ${m.text||''}`:eh((m.text||'').substring(0,30));}
function filterC(q){ onSearch(q); } // backward compat

/* ‚îÄ‚îÄ MUTED CHATS ‚îÄ‚îÄ */
let mutedChats = JSON.parse(localStorage.getItem('hrd_muted')||'{}');
function openMuteModal(){
  if(!CC) return;
  const muted = (mutedChats[CC.id]||0) > Date.now() || mutedChats[CC.id]===-1;
  if(muted){ unmuteChat(); return; }
  om2('mutem');
}
function muteChatFor(ms){
  if(!CC) return;
  mutedChats[CC.id] = ms===-1 ? -1 : Date.now()+ms;
  localStorage.setItem('hrd_muted', JSON.stringify(mutedChats));
  cm2('mutem');
  toast('üîï –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–≥–ª—É—à–µ–Ω—ã','ok');
  const ic=document.getElementById('muteIc'),tx=document.getElementById('muteTxt');
  if(ic)ic.textContent='üîî';if(tx)tx.textContent='–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
}
function unmuteChat(){
  if(!CC) return;
  delete mutedChats[CC.id];
  localStorage.setItem('hrd_muted', JSON.stringify(mutedChats));
  toast('üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã','ok');
  const ic=document.getElementById('muteIc'),tx=document.getElementById('muteTxt');
  if(ic)ic.textContent='üîï';if(tx)tx.textContent='–ó–∞–≥–ª—É—à–∏—Ç—å —á–∞—Ç';
}

/* ‚îÄ‚îÄ MEDIA GALLERY ‚îÄ‚îÄ */
async function openGallery(){
  if(!CC) return toast('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π —á–∞—Ç','err');
  om2('gallm');
  const grid = document.getElementById('gallGrid');
  grid.innerHTML = '<div class="gallery-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  const sn = await get(ref(db,'messages'));
  if(!sn.exists()){ grid.innerHTML='<div class="gallery-empty">–ù–µ—Ç –º–µ–¥–∏–∞</div>'; return; }
  const ms = sn.val();
  const imgs = [];
  for(let id in ms){
    const m = ms[id];
    if(m.type==='image' && ((m.from===CU.id&&m.to===CC.id)||(m.from===CC.id&&m.to===CU.id))){
      imgs.push({src:m.imageData, ts:m.timestamp});
    }
  }
  imgs.sort((a,b)=>b.ts-a.ts);
  if(!imgs.length){ grid.innerHTML='<div class="gallery-empty">üì≠ –ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ</div>'; return; }
  grid.innerHTML='';
  imgs.forEach(img=>{
    const el = document.createElement('img');
    el.className='gal-img'; el.src=img.src;
    el.onclick=()=>{cm2('gallm');previewImg(img.src);};
    grid.appendChild(el);
  });
}

/* ‚ïê‚ïê END CONTACTS REWRITE ‚ïê‚ïê */


/* OPEN CHAT */
function openChat(c){
  CC=c;if(msgUnsub){msgUnsub();msgUnsub=null;}if(stUnsub){stUnsub();stUnsub=null;}
  document.getElementById('viewList').style.display='none';
  const vc=document.getElementById('viewChat');vc.classList.add('on');
  document.getElementById('chav').src=c.avatar||defAva(c.username);
  document.getElementById('chav').className='chat-ava'+(c.online?' online':'');
  document.getElementById('chn').innerHTML=getDisplayName(c);updSt(c);
  unread[c.id]=0;newMsgCount=0;refreshUnreadBadge();clearReply();clearFwd();clearPin();closeChatSearch();closeEmojiPicker();
  // Load draft if exists
  const mi = document.getElementById('mi');
  const savedDraft = loadDraft(c.id);
  if(mi){ mi.value = savedDraft; if(savedDraft) toast('üìù –ß–µ—Ä–Ω–æ–≤–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω','info'); }
  loadMsgs(c);
  stUnsub=onValue(ref(db,`users/${c.id}`),sn=>{if(sn.exists()){CC={...CC,...sn.val(),id:c.id};updSt(CC);document.getElementById('chn').innerHTML=getDisplayName(CC);document.getElementById('chav').className='chat-ava'+(CC.online?' online':'');}});
  onValue(ref(db,`typing/${c.id}_${CU.id}`),sn=>{const tw=document.getElementById('twrap');if(sn.exists()&&sn.val().typing&&(Date.now()-sn.val().ts)<4000){document.getElementById('twho').textContent=`${CC?.username||''} –ø–µ—á–∞—Ç–∞–µ—Ç...`;tw.classList.add('on');}else tw.classList.remove('on');});
}
function updSt(c){const e=document.getElementById('chs');if(!e)return;let s=c.online?'<span style="color:var(--green)">‚óè –í —Å–µ—Ç–∏</span>':(c.lastSeen?`–±—ã–ª(–∞) ${ft(c.lastSeen)}`:'–æ—Ñ—Ñ–ª–∞–π–Ω');if(c.statusText)s+=`<span style="font-style:italic;color:var(--txt3);margin-left:6px;">${eh(c.statusText)}</span>`;e.innerHTML=s;}

/* MESSAGES */
function loadMsgs(c){
  const ma=document.getElementById('ma');ma.innerHTML='<div style="text-align:center;color:var(--txt3);padding:40px;font-size:13px;">–∑–∞–≥—Ä—É–∑–∫–∞...</div>';
  let lastD=null;
  msgUnsub=onValue(ref(db,'messages'),sn=>{
    const atBottom=ma.scrollHeight-ma.scrollTop-ma.clientHeight<120;
    ma.innerHTML='';lastD=null;
    if(!sn.exists()){ma.innerHTML=emptyChat(c.username);return;}
    const all=sn.val(),msgs=[];
    for(let id in all){const m=all[id];if((m.from===CU.id&&m.to===c.id)||(m.from===c.id&&m.to===CU.id))msgs.push({id,...m});}
    if(!msgs.length){ma.innerHTML=emptyChat(c.username);return;}
    msgs.sort((a,b)=>a.timestamp-b.timestamp);
    let wasNew=false;
    msgs.forEach(m=>{
      const d=new Date(m.timestamp).toDateString();
      if(d!==lastD){lastD=d;const dd=document.createElement('div');dd.className='dd';dd.innerHTML=`<span>${new Date(m.timestamp).toLocaleDateString('ru-RU',{day:'numeric',month:'long'})}</span>`;ma.appendChild(dd);}
      ma.appendChild(buildMsg(m));
      if(m.from===c.id&&m.to===CU.id&&!m.read){
        update(ref(db,`messages/${m.id}`),{read:true});
        const isMuted=(mutedChats[c.id]||0)>Date.now()||mutedChats[c.id]===-1;
        // Browser notification
        if(!isMuted&&document.hidden&&'Notification' in window&&Notification.permission==='granted'){
          new Notification(`HARD ¬∑ ${c.username}`,{body:previewMsgText(m),icon:c.avatar||''});
        }
        if(!isMuted&&S.sound&&wasNew!==undefined)playBeep();
        wasNew=true;
      }
    });
    if(atBottom||msgs.length<=3){ma.scrollTop=ma.scrollHeight;newMsgCount=0;document.getElementById('scrollBtn').classList.remove('on');}
    else if(wasNew){newMsgCount++;const sb=document.getElementById('scrollBtn');sb.classList.add('on');const sbu=document.getElementById('sbu');sbu.style.display='block';sbu.textContent=newMsgCount>9?'9+':String(newMsgCount);}
    loadPinned(c.id);
  });
  ma.addEventListener('scroll',()=>{if(ma.scrollHeight-ma.scrollTop-ma.clientHeight<80){document.getElementById('scrollBtn').classList.remove('on');newMsgCount=0;}},{passive:true});
}
function emptyChat(n){return`<div style="flex:1;min-height:200px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;padding:32px;text-align:center;color:var(--txt3);"><span style="font-size:32px;">üí¨</span><span style="font-family:IBM Plex Mono,monospace;font-size:13px;letter-spacing:.08em;">–Ω–∞—á–Ω–∏ –ø–µ—Ä–µ–ø–∏—Å–∫—É —Å ${eh(n)}</span></div>`;}
function scrollToBottom(s){const ma=document.getElementById('ma');ma.scrollTo({top:ma.scrollHeight,behavior:s?'smooth':'auto'});newMsgCount=0;document.getElementById('scrollBtn').classList.remove('on');document.getElementById('sbu').style.display='none';}

const REACT=['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üî•','üíÄ','ü§Ø'];
function buildMsg(m){
  const out=m.from===CU.id;
  const w=document.createElement('div');w.className=`mw ${out?'out':'in'}`;w.dataset.mid=m.id;
  const qa=document.createElement('div');qa.className='qact';qa.style.display='none';
  qa.innerHTML=REACT.map(e=>`<button class="qab" onclick="addReaction('${m.id}','${e}')">${e}</button>`).join('')+`<button class="qab" onclick="setReply('${m.id}','${(m.text||'').replace(/'/g,'&#39;').replace(/\n/g,' ').substring(0,80)}','${eh(out?'–í—ã':CC?.username||'')}')" title="–û—Ç–≤–µ—Ç–∏—Ç—å">‚Ü©</button><button class="qab" onclick="showFwdModal('${m.id}')" title="–ü–µ—Ä–µ—Å–ª–∞—Ç—å">‚Üó</button>`;
  w.appendChild(qa);
  const mb=document.createElement('div');mb.className='mb';mb.id='mb_'+m.id;
  let cnt='';
  if(m.replyText)cnt+=`<div class="mb-quote"><div class="qn">${eh(m.replyFrom||'')}</div><div class="qtext">${eh(m.replyText.substring(0,80))}</div></div>`;
  if(m.forwarded)cnt+=`<div style="font-size:10px;color:var(--txt3);margin-bottom:4px;font-family:IBM Plex Mono,monospace;">‚Üó –ü–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç ${eh(m.forwardedFrom||'')}</div>`;
  if(m.type==='image'){cnt+=`<img class="msg-img" src="${m.imageData}" onclick="previewImg('${m.imageData}')">`;if(m.text&&m.text!=='üì∑ –§–æ—Ç–æ')cnt+=`<div style="margin-top:5px;">${parseText(m.text)}</div>`;}
  else if(m.type==='file'){cnt+=`<div style="display:flex;align-items:center;gap:10px;"><span style="font-size:24px;">üìÑ</span><div><div style="font-size:14px;font-weight:500;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${eh(m.fileName||'–§–∞–π–ª')}</div><a href="${m.fileData}" download="${eh(m.fileName||'file')}" style="color:var(--red-l);font-size:12px;font-family:IBM Plex Mono,monospace;">‚Üì —Å–∫–∞—á–∞—Ç—å</a></div></div>`;}
  else if(m.type==='gif'){cnt+=`<img src="${eh(m.gifUrl||m.gifPreview||'')}" style="max-width:220px;max-height:180px;border-radius:12px;display:block;cursor:pointer;" onclick="previewImg('${eh(m.gifUrl||'')}')"><div style="font-size:10px;color:var(--txt3);margin-top:2px;font-family:IBM Plex Mono,monospace;">GIF</div>`;}
  else if(m.type==='voice'){const totalSec=m.voiceSeconds||0;cnt+=`<div class="vplayer"><button class="vpl-btn" id="vbtn_${m.id}" onclick="playVoice('${m.voiceData}',document.getElementById('vbtn_${m.id}'),document.getElementById('vprog_${m.id}'),document.getElementById('vfill_${m.id}'),document.getElementById('vdur_${m.id}'),${totalSec})">‚ñ∂</button><div class="vpl-prog" id="vprog_${m.id}"><div class="vpl-fill" id="vfill_${m.id}"></div></div><span class="vpl-dur" id="vdur_${m.id}">${m.voiceDuration||'0:00'}</span></div>`;}
  else if(m.type==='sticker'){cnt+=`<span class="msg-sticker">${eh(m.stickerEmoji||'')}</span>`;}
  else if(m.type==='dice'){cnt+=`<span class="dice-face">${eh(m.text||'‚öÄ')}</span><span class="dice-val">üé≤ –í—ã–ø–∞–ª–æ: ${m.diceValue||'?'}</span>`;}
  else{let txt=parseText(m.text||'');if(m.edited)txt+=` <span style="font-size:10px;color:var(--txt3);font-family:IBM Plex Mono,monospace;">(—Ä–µ–¥.)</span>`;cnt+=txt;}
  mb.innerHTML=cnt;w.appendChild(mb);
  const mm=document.createElement('div');mm.className='mm';
  mm.innerHTML=`${ft(m.timestamp)}${out?(m.read?` <span class="ri r">‚úì‚úì</span>`:` <span class="ri">‚úì</span>`):''}`; 
  w.appendChild(mm);
  if(m.reactions&&Object.keys(m.reactions).length){
    const rrow=document.createElement('div');rrow.className='react-row';
    const counts={};for(let uid in m.reactions){const e=m.reactions[uid];counts[e]=(counts[e]||0)+1;}
    for(let em in counts){const mine=m.reactions[CU.id]===em;const pill=document.createElement('div');pill.className='rpill'+(mine?' mine':'');pill.innerHTML=`${em}<span class="rc">${counts[em]}</span>`;pill.onclick=()=>addReaction(m.id,em);rrow.appendChild(pill);}
    w.appendChild(rrow);
  }
  if(m.selfDestruct&&m.from!==CU.id){
    const sd=document.createElement('div');sd.className='sd-timer';sd.textContent='30s';mb.style.border='1px solid rgba(229,57,53,.25)';
    w.appendChild(sd);let t=30;
    const iv=setInterval(async()=>{t--;if(t<=0){clearInterval(iv);try{await remove(ref(db,`messages/${m.id}`));}catch(e){}}else sd.textContent=t+'s';},1000);
  }
  // Long press
  let lpt=null;
  w.addEventListener('touchstart',e=>{lpt=setTimeout(()=>{qa.style.display='flex';},500);},{passive:true});
  w.addEventListener('touchend',()=>{clearTimeout(lpt);});
  w.addEventListener('contextmenu',e=>{e.preventDefault();showCxbs(m);});
  document.addEventListener('touchstart',function handler(e){if(!w.contains(e.target)){qa.style.display='none';document.removeEventListener('touchstart',handler);}},{passive:true});
  return w;
}

async function addReaction(msgId,emoji){if(!CU)return;try{const sn=await get(ref(db,`messages/${msgId}/reactions/${CU.id}`));if(sn.exists()&&sn.val()===emoji)await remove(ref(db,`messages/${msgId}/reactions/${CU.id}`));else await update(ref(db,`messages/${msgId}/reactions`),{[CU.id]:emoji});}catch(e){}}
function addReactionCtx(emoji){if(selMsg)addReaction(selMsg.id,emoji);hideCxbs();}
async function loadPinned(cid){const key=`pin_${[CU.id,cid].sort().join('_')}`;try{const sn=await get(ref(db,`pins/${key}`));const bar=document.getElementById('pinnedBar');if(sn.exists()){pinMsgId=sn.val().msgId;document.getElementById('pinText').textContent=sn.val().text||'(–º–µ–¥–∏–∞)';bar.classList.add('on');}else{bar.classList.remove('on');pinMsgId=null;}}catch(e){}}
async function pinMsg(msgId,text){if(!CC)return;const key=`pin_${[CU.id,CC.id].sort().join('_')}`;try{await set(ref(db,`pins/${key}`),{msgId,text:text.substring(0,100)});toast('üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ','ok');}catch(e){toast('–û—à–∏–±–∫–∞','err');}}
async function clearPin(){if(!CC)return;const key=`pin_${[CU.id,CC.id].sort().join('_')}`;try{await remove(ref(db,`pins/${key}`));document.getElementById('pinnedBar').classList.remove('on');}catch(e){}}
function scrollToPin(){if(!pinMsgId)return;const el=document.getElementById('mb_'+pinMsgId);if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.outline='1px solid var(--red)';setTimeout(()=>el.style.outline='',1600);}}
function setReply(msgId,text,from){replyTo={msgId,text,from};document.getElementById('replyPrev').textContent=`${from}: ${text.substring(0,55)}`;document.getElementById('replyBar').classList.add('on');document.getElementById('mi').focus();}
function clearReply(){replyTo=null;document.getElementById('replyBar').classList.remove('on');}
function clearFwd(){fwdMsg=null;document.getElementById('fwdBar').classList.remove('on');}

// Forward
function showFwdModal(msgId){
  const m=selMsg||(msgId?{id:msgId}:null);
  if(!m)return;
  fwdMsg=m;
  hideCxbs();
  const cont=document.getElementById('fwdContacts');
  cont.innerHTML='';
  allC.forEach(c=>{
    const d=document.createElement('div');
    d.style.cssText='display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer;transition:.1s;';
    d.innerHTML=`<img src="${c.avatar||defAva(c.username)}" style="width:40px;height:40px;border-radius:50%;"><div><div style="font-size:14px;font-weight:500;">${getDisplayName(c)}</div><div style="font-size:12px;color:var(--txt2);">${c.online?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ—Ñ–ª–∞–π–Ω'}</div></div>`;
    d.onclick=()=>forwardTo(c);
    d.addEventListener('touchstart',()=>d.style.background='var(--p2)',{passive:true});
    d.addEventListener('touchend',()=>d.style.background='',{passive:true});
    cont.appendChild(d);
  });
  om2('fwdMo');
}
async function forwardTo(contact){
  if(!fwdMsg)return;
  cm2('fwdMo');
  // Get original message data
  let origMsg=fwdMsg;
  if(!origMsg.from){
    const sn=await get(ref(db,`messages/${origMsg.id}`));
    if(sn.exists())origMsg={id:origMsg.id,...sn.val()};
  }
  const from=origMsg.from===CU.id?CU.username:(CC?.username||'?');
  const msg={from:CU.id,to:contact.id,text:origMsg.text||'',type:origMsg.type||'text',timestamp:Date.now(),read:false,forwarded:true,forwardedFrom:from};
  if(origMsg.imageData)msg.imageData=origMsg.imageData;
  if(origMsg.gifUrl){msg.gifUrl=origMsg.gifUrl;msg.gifPreview=origMsg.gifPreview;}
  if(origMsg.stickerEmoji)msg.stickerEmoji=origMsg.stickerEmoji;
  contactLastMsgCache[contact.id]=null;
  try{await push(ref(db,'messages'),msg);toast('‚Üó –ü–µ—Ä–µ—Å–ª–∞–Ω–æ','ok');}catch(e){toast('–û—à–∏–±–∫–∞','err');}
  fwdMsg=null;
}

/* CTX */
function showCxbs(msg){selMsg=msg;const own=msg.from===CU.id;// edit
document.getElementById('cxEdit').style.display=own&&!msg.type?'flex':'none';document.getElementById('cxDel').style.display=own?'flex':'none';document.getElementById('cxTpl').style.display='flex';om2('cxbs');}
function hideCxbs(){cm2('cxbs');}
document.getElementById('cxCopy').onclick=()=>{navigator.clipboard.writeText(selMsg?.text||'').then(()=>toast('‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ','ok'));hideCxbs();};
document.getElementById('cxReply').onclick=()=>{if(selMsg)setReply(selMsg.id,selMsg.text||'',selMsg.from===CU.id?'–í—ã':CC?.username||'?');hideCxbs();};
document.getElementById('cxFwd').onclick=()=>{if(selMsg)showFwdModal(selMsg.id);};
document.getElementById('cxPin').onclick=()=>{if(selMsg)pinMsg(selMsg.id,selMsg.text||'');hideCxbs();};
document.getElementById('cxBookmark').onclick=()=>{if(selMsg)bookmarkMsg(selMsg);hideCxbs();};
document.getElementById('cxEdit').onclick=()=>{if(selMsg)startEdit();};
// edit
document.getElementById('cxEdit').onclick=()=>{if(!selMsg)return;editMsg=selMsg;document.getElementById('editTxt').value=selMsg.text||'';om2('editm');hideCxbs();};
document.getElementById('cxDel').onclick=async()=>{if(!selMsg)return;try{await remove(ref(db,`messages/${selMsg.id}`));contactLastMsgCache[CC.id]=null;toast('‚úì –£–¥–∞–ª–µ–Ω–æ','ok');}catch(e){}hideCxbs();};
document.getElementById('editSave').onclick=async()=>{if(!editMsg)return;const t=document.getElementById('editTxt').value.trim();if(!t)return;try{await update(ref(db,`messages/${editMsg.id}`),{text:t,edited:true});toast('‚úì –ò–∑–º–µ–Ω–µ–Ω–æ','ok');}catch(e){}cm2('editm');editMsg=null;};

/* BOOKMARKS */
function bookmarkMsg(msg){
  bookmarks=bookmarks.filter(b=>b.id!==msg.id);
  bookmarks.unshift({id:msg.id,text:msg.text||previewMsgText(msg),from:msg.from===CU.id?'–í—ã':(CC?.username||'?'),ts:msg.timestamp,chatWith:CC?.id});
  if(bookmarks.length>50)bookmarks=bookmarks.slice(0,50);
  localStorage.setItem('hard_bk',JSON.stringify(bookmarks));
  toast('üîñ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ','ok');
}
function openBookmarks(){
  const list=document.getElementById('bkList');
  if(!bookmarks.length){list.innerHTML='<div style="color:var(--txt3);font-size:13px;padding:8px;">–ù–µ—Ç –∑–∞–∫–ª–∞–¥–æ–∫</div>';}
  else{
    list.innerHTML='';
    bookmarks.forEach(b=>{
      const d=document.createElement('div');
      d.className='bk-item';
      d.innerHTML=`<div class="bk-time">${b.from} ¬∑ ${ft(b.ts)}</div><div class="bk-txt">${eh(b.text?.substring(0,80)||'(–º–µ–¥–∏–∞)')}</div>`;
      d.onclick=()=>{
        cm2('bkMo');
        // Navigate to chat with the person who has this message
        const contact=allC.find(c=>c.id===b.chatWith);
        if(contact){openChat(contact);setTimeout(()=>{const el=document.getElementById('mb_'+b.id);if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.outline='1px solid var(--gold)';setTimeout(()=>el.style.outline='',1800);}},600);}
      };
      list.appendChild(d);
    });
  }
  om2('bkMo');
}

/* SEND */
async function sendMsg(){
  if(!CC)return;
  if(CC.isGroup||CC.isChannel){sendGroupMsg();return;}
  const inp=document.getElementById('mi');const txt=inp.value.trim();
  // Edit mode
  if(editingMsgId){
    if(!txt){cancelEdit();return;}
    try{await update(ref(db,`messages/${editingMsgId}`),{text:txt,edited:true,editedAt:Date.now()});cancelEdit();toast('‚úì –°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ','ok');}catch(e){toast('–û—à–∏–±–∫–∞','err');}
    return;
  }
  // Quick commands
  if(txt==='/dice'||txt==='/roll'){inp.value='';const d=rollDice();const msg={from:CU.id,to:CC.id,text:d.face,type:'dice',diceValue:d.val,timestamp:Date.now(),read:false};contactLastMsgCache[CC.id]=null;try{await push(ref(db,'messages'),msg);playClink();}catch(e){toast('–û—à–∏–±–∫–∞','err');}return;}
  if(txt==='/flip'){inp.value='';const r=Math.random()>.5?'ü™ô –û—Ä—ë–ª':'üèÖ –†–µ—à–∫–∞';const msg={from:CU.id,to:CC.id,text:r,timestamp:Date.now(),read:false};contactLastMsgCache[CC.id]=null;try{await push(ref(db,'messages'),msg);}catch(e){}return;}
  if(txt.startsWith('/me ')){const action=txt.slice(4);inp.value='';const msg={from:CU.id,to:CC.id,text:`*${CU.username} ${action}*`,timestamp:Date.now(),read:false};contactLastMsgCache[CC.id]=null;try{await push(ref(db,'messages'),msg);}catch(e){}return;}
  if(txt==='/clear'){inp.value='';toast('–ö–æ–º–º–∞–Ω–¥–∞ /me <–¥–µ–π—Å—Ç–≤–∏–µ> ¬∑ /clear —Å–ø—Ä–∞–≤–∫–∞','info');return;}
  if(!txt)return;
  inp.value='';inp.style.height='auto';
  saveDraft(CC.id, ''); // clear draft after send
  update(ref(db,`typing/${CU.id}_${CC.id}`),{typing:false});
  const msg={from:CU.id,to:CC.id,text:txt,timestamp:Date.now(),read:false};
  if(S.hardPlus&&S.selfDestruct)msg.selfDestruct=true;
  if(replyTo){msg.replyText=replyTo.text.substring(0,80);msg.replyFrom=replyTo.from;msg.replyMsgId=replyTo.msgId;}
  clearReply();clearFwd();
  contactLastMsgCache[CC.id]=null;
  try{await push(ref(db,'messages'),msg);if(S.sound)playBeep();}catch(e){toast('–û—à–∏–±–∫–∞','err');}
}
async function sendFile(inp){const files=[...inp.files];if(!files.length||!CC)return;for(const f of files){if(f.size>1200000){toast(`${f.name} >1MB`,'err');continue;}const r=new FileReader();await new Promise(res=>{r.onload=async e=>{const isImg=f.type.startsWith('image/');const msg={from:CU.id,to:CC.id,type:isImg?'image':'file',imageData:isImg?e.target.result:null,fileData:!isImg?e.target.result:null,fileName:f.name,text:isImg?'üì∑ –§–æ—Ç–æ':`üìÑ ${f.name}`,timestamp:Date.now(),read:false};contactLastMsgCache[CC.id]=null;try{await push(ref(db,'messages'),msg);}catch(err){}res();};r.readAsDataURL(f);});}toast('‚úì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ','ok');inp.value='';}

/* TEXTAREA */
const miEl=document.getElementById('mi');
miEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}});
miEl.addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px';if(CC&&CU){update(ref(db,`typing/${CU.id}_${CC.id}`),{typing:true,ts:Date.now()});clearTimeout(typTO);typTO=setTimeout(()=>{if(CU&&CC)update(ref(db,`typing/${CU.id}_${CC.id}`),{typing:false});},2500);}if(CC)saveDraft(CC.id,this.value);});

/* VOICE */
function startVoiceRec(){if(!CC)return;navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{voiceStream=stream;const mimeType=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':MediaRecorder.isTypeSupported('audio/webm')?'audio/webm':'audio/ogg';voiceRec=new MediaRecorder(stream,{mimeType});const chunks=[];voiceRec.ondataavailable=e=>{if(e.data&&e.data.size>0)chunks.push(e.data);};voiceRec.onstop=()=>{const blob=new Blob(chunks,{type:mimeType});const r=new FileReader();r.onload=e=>{window.voiceBlob=e.target.result;};r.readAsDataURL(blob);};voiceRec.start(100);voiceTime=0;document.getElementById('voiceRec').classList.add('on');voiceTimer=setInterval(()=>{voiceTime++;const m=Math.floor(voiceTime/60),s=voiceTime%60;document.getElementById('vtime').textContent=`${m}:${s.toString().padStart(2,'0')}`;},1000);}).catch(e=>toast('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω','err'));}
function stopVoiceRec(){if(!voiceRec||voiceRec.state==='inactive')return;voiceRec.stop();clearInterval(voiceTimer);if(voiceStream)voiceStream.getTracks().forEach(t=>t.stop());}
function cancelVoice(){stopVoiceRec();document.getElementById('voiceRec').classList.remove('on');window.voiceBlob=null;}
async function sendVoice(){if(!window.voiceBlob||!CC)return;stopVoiceRec();document.getElementById('voiceRec').classList.remove('on');const m=Math.floor(voiceTime/60),s=voiceTime%60;const dur=`${m}:${s.toString().padStart(2,'0')}`;const msg={from:CU.id,to:CC.id,type:'voice',voiceData:window.voiceBlob,voiceDuration:dur,voiceSeconds:voiceTime,timestamp:Date.now(),read:false};contactLastMsgCache[CC.id]=null;try{await push(ref(db,'messages'),msg);if(S.sound)playBeep();window.voiceBlob=null;toast('‚úì –ì–æ–ª–æ—Å–æ–≤–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ','ok');}catch(e){toast('–û—à–∏–±–∫–∞','err');}}
function playVoice(data,btnEl,progEl,fillEl,durEl,totalSec){const k=data.substring(0,50);if(voiceAudios[k]&&!voiceAudios[k].paused){voiceAudios[k].pause();btnEl.textContent='‚ñ∂';return;}if(voiceAudios[k]&&voiceAudios[k].paused){voiceAudios[k].play();btnEl.textContent='‚è∏';return;}const audio=new Audio(data);voiceAudios[k]=audio;audio.addEventListener('timeupdate',()=>{const pct=(audio.currentTime/(audio.duration||1))*100;if(fillEl)fillEl.style.width=pct+'%';if(durEl){const r=Math.max(0,Math.ceil((audio.duration||0)-audio.currentTime));const rm=Math.floor(r/60),rs=r%60;durEl.textContent=`${rm}:${rs.toString().padStart(2,'0')}`;};});audio.addEventListener('ended',()=>{btnEl.textContent='‚ñ∂';if(fillEl)fillEl.style.width='0%';if(durEl)durEl.textContent=totalSec?`${Math.floor(totalSec/60)}:${(totalSec%60).toString().padStart(2,'0')}`:'0:00';delete voiceAudios[k];});audio.play().then(()=>btnEl.textContent='‚è∏').catch(e=>toast('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è','err'));}

/* PROFILE */
async function changeAvatar(inp){const f=inp.files[0];if(!f)return;if(f.size>600000){toast('–§–∞–π–ª >600KB','err');return;}const r=new FileReader();r.onload=async e=>{try{await update(ref(db,`users/${CU.id}`),{avatar:e.target.result});CU.avatar=e.target.result;document.getElementById('topAva').src=e.target.result;toast('‚úì –ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω','ok');}catch(err){toast('–û—à–∏–±–∫–∞','err');}};r.readAsDataURL(f);}
async function toggleOnlineSt(v){sv('onlineStatus',v);if(CU)await update(ref(db,`users/${CU.id}`),{online:v});}
async function openMyProfile(){
  if(!CU)return;
  document.getElementById('mpa').src=CU.avatar||defAva(CU.username);
  document.getElementById('mpn').innerHTML=getDisplayName(CU);
  document.getElementById('mpun').textContent=CU.username;
  document.getElementById('mpid').textContent=CU.id;
  document.getElementById('mpcr').textContent=CU.createdAt?new Date(CU.createdAt).toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'}):'‚Äî';
  // Count messages
  const sn=await get(ref(db,'messages'));
  let cnt=0;if(sn.exists())for(let id in sn.val())if(sn.val()[id].from===CU.id)cnt++;
  document.getElementById('mpMsgCount').textContent=cnt;
  om2('mpm');
}
function openUserProfile(){if(!CC)return;document.getElementById('upa').src=CC.avatar||defAva(CC.username);document.getElementById('upn').innerHTML=getDisplayName(CC);const statusHtml=CC.statusText?`<div style="font-size:12px;color:var(--txt2);font-style:italic;margin-top:3px;">${eh(CC.statusText)}</div>`:'';document.getElementById('ups').innerHTML=(CC.online?'<span style="color:var(--green)">‚óè –í —Å–µ—Ç–∏</span>':(CC.lastSeen?`–±—ã–ª(–∞) ${ft(CC.lastSeen)}`:'–æ—Ñ—Ñ–ª–∞–π–Ω'))+statusHtml;om2('upm');}
async function showOnlineUsers(){const sn=await get(ref(db,'users'));const list=document.getElementById('oll');list.innerHTML='';if(!sn.exists()){list.innerHTML='<div style="color:var(--txt3);font-size:13px;">–ù–µ—Ç</div>';om2('olm');return;}const us=sn.val();let cnt=0;for(let id in us){const u=us[id];if(u.online&&id!==CU?.id){cnt++;const d=document.createElement('div');d.style.cssText='display:flex;align-items:center;gap:10px;padding:11px 0;border-bottom:1px solid rgba(255,255,255,.03);cursor:pointer;';d.innerHTML=`<img src="${u.avatar||defAva(u.username)}" style="width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid var(--green);box-shadow:0 0 8px rgba(67,160,71,.4);"><div><div style="font-size:15px;font-weight:500;">${getDisplayName(u)}</div><div style="font-size:11px;color:var(--green);">‚óè –æ–Ω–ª–∞–π–Ω</div></div>`;const contact=allC.find(c=>c.id===id);if(contact)d.onclick=()=>{cm2('olm');openChat(contact);};list.appendChild(d);}}if(!cnt)list.innerHTML='<div style="color:var(--txt3);font-size:13px;padding:8px 0;">–Ω–∏–∫–æ–≥–æ –Ω–µ—Ç –æ–Ω–ª–∞–π–Ω</div>';om2('olm');}

/* DELETE/LOGOUT */
function confirmDelChat(){if(!CC)return;document.getElementById('cft').textContent='–£–¥–∞–ª–∏—Ç—å —á–∞—Ç';document.getElementById('cfs').textContent=`–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É —Å ${CC.username}?`;document.getElementById('cfb').onclick=delChat;om2('cfm');}
async function delChat(){cm2('cfm');cm2('upm');if(!CC)return;try{const sn=await get(ref(db,'messages'));if(sn.exists())for(let id in sn.val()){const m=sn.val()[id];if((m.from===CU.id&&m.to===CC.id)||(m.from===CC.id&&m.to===CU.id))await remove(ref(db,`messages/${id}`));}contactLastMsgCache[CC.id]=null;toast('‚úì –ß–∞—Ç —É–¥–∞–ª—ë–Ω','ok');goBack();}catch(e){toast('–û—à–∏–±–∫–∞','err');}}
async function logoutUser(){if(!CU)return;try{await update(ref(db,`users/${CU.id}`),{online:false,lastSeen:Date.now()});}catch(e){}if(msgUnsub)msgUnsub();if(cUnsub)cUnsub();if(stUnsub)stUnsub();CU=null;CC=null;document.getElementById('app').style.display='none';closeMenu();showSc('lw');}
async function exportChat(){if(!CC)return;try{const sn=await get(ref(db,'messages'));if(!sn.exists()){toast('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π','err');return;}const all=sn.val(),msgs=[];for(let id in all){const m=all[id];if((m.from===CU.id&&m.to===CC.id)||(m.from===CC.id&&m.to===CU.id))msgs.push({id,...m});}if(!msgs.length){toast('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π','err');return;}msgs.sort((a,b)=>a.timestamp-b.timestamp);let txt=`–≠–∫—Å–ø–æ—Ä—Ç —á–∞—Ç–∞ —Å ${CC.username}\n\n`;msgs.forEach(m=>{const from=m.from===CU.id?'–í—ã':CC.username;txt+=`[${new Date(m.timestamp).toLocaleString('ru-RU')}] ${from}: ${m.text||'(–º–µ–¥–∏–∞)'}\n`;});const blob=new Blob([txt],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`chat_${CC.username}.txt`;a.click();toast('‚úì –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ','ok');}catch(e){toast('–û—à–∏–±–∫–∞','err');}}

/* SEARCH */
function toggleChatSearch(){const bar=document.getElementById('chatSB');const isOn=bar.style.display==='flex';bar.style.display=isOn?'none':'flex';if(!isOn)document.getElementById('chatSI').focus();else closeChatSearch();}
function closeChatSearch(){document.getElementById('chatSB').style.display='none';document.getElementById('chatSI').value='';srchResults=[];srchI=0;document.getElementById('srchInfo').textContent='';}
function searchMsgs(q){srchResults=[];srchI=0;if(!q.trim()){document.getElementById('srchInfo').textContent='';return;}const ql=q.toLowerCase();document.querySelectorAll('.mb').forEach(el=>{if(el.textContent.toLowerCase().includes(ql))srchResults.push(el);});document.getElementById('srchInfo').textContent=srchResults.length?`${srchResults.length}`:'‚Äî';if(srchResults.length)navSearch(0,true);}
function navSearch(dir,init=false){if(!srchResults.length)return;if(!init)srchI=((srchI+dir)+srchResults.length)%srchResults.length;srchResults[srchI].scrollIntoView({behavior:'smooth',block:'center'});srchResults[srchI].style.outline='1px solid var(--red)';setTimeout(()=>{if(srchResults[srchI])srchResults[srchI].style.outline='';},1200);}

/* GIF */
function openGif(){if(!CC)return toast('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π —á–∞—Ç','err');om2('gifMo');document.getElementById('gifSearchI').value='';loadGifs('–ø—Ä–∏–≤–µ—Ç');}
function searchGif(q){clearTimeout(gifTO);gifTO=setTimeout(()=>loadGifs(q||'hello'),600);}
async function loadGifs(q){
  const grid=document.getElementById('gifGrid');grid.innerHTML='<div style="color:var(--txt3);font-size:12px;padding:10px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  try{const r=await fetch(`https://api.giphy.com/v1/gifs/search?api_key=dc6zaTOxFJmzC&q=${encodeURIComponent(q)}&limit=9&rating=pg-13`);const d=await r.json();grid.innerHTML='';if(!d.data||!d.data.length){grid.innerHTML='<div style="color:var(--txt3);font-size:12px;padding:10px;">–ù–∏—á–µ–≥–æ</div>';return;}d.data.forEach(g=>{const img=document.createElement('img');img.src=g.images.fixed_height_small.url;img.loading='lazy';img.onclick=()=>sendGif(g.images.original.url,g.images.fixed_height_small.url);grid.appendChild(img);});}catch(e){grid.innerHTML='<div style="color:#ef9a9a;font-size:12px;padding:10px;">–û—à–∏–±–∫–∞</div>';}
}
async function sendGif(url,preview){if(!CC)return;cm2('gifMo');const msg={from:CU.id,to:CC.id,type:'gif',gifUrl:url,gifPreview:preview||url,text:'üé¨ GIF',timestamp:Date.now(),read:false};contactLastMsgCache[CC.id]=null;try{await push(ref(db,'messages'),msg);if(S.sound)playBeep();}catch(e){toast('–û—à–∏–±–∫–∞','err');}}

/* STICKERS */
const STICKERS=['ü§£','üò≠','üíÄ','üî•','‚ù§Ô∏è‚Äçüî•','ü•¥','üò§','ü§Ø','ü§å','üíÖ','üêê','üëÄ','ü´°','ü§°','üí©','ü¶æ','üòà','üëÅÔ∏è','üé≠','ü§´','üòé','ü•∂','ü§§','üòè','üí£','üï∂Ô∏è','ü´∂','üôå','ü´†','üòµ‚Äçüí´','ü§∑','ü¶ã','üåö','‚ö°','üëæ','üéÆ','üèÜ','üéØ','üîÆ','üíé','üåà','üçï','üéµ','üöÄ','üõ∏','üåô','‚ò†Ô∏è','ü¶ä','üê±','üêâ','üé™','ü™Ñ','üé∏','ü•Å','üéπ'];
function openStickers(){if(!S.hardPlus)return toast('–ù—É–∂–µ–Ω Hard+','err');const g=document.getElementById('stkGrid');g.innerHTML='';STICKERS.forEach(s=>{const b=document.createElement('button');b.style.cssText='font-size:32px;background:none;border:none;cursor:pointer;padding:5px;border-radius:10px;transition:.2s;';b.textContent=s;b.onclick=()=>{cm2('stkm');sendSticker(s);};g.appendChild(b);});om2('stkm');}
async function sendSticker(emoji){if(!CC)return;const msg={from:CU.id,to:CC.id,type:'sticker',stickerEmoji:emoji,text:'',timestamp:Date.now(),read:false};contactLastMsgCache[CC.id]=null;try{await push(ref(db,'messages'),msg);if(S.sound)playBeep();}catch(e){toast('–û—à–∏–±–∫–∞','err');}}

/* CHAT STATS */
async function openChatStats(){if(!CC)return toast('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π —á–∞—Ç','err');const sn=await get(ref(db,'messages'));if(!sn.exists()){om2('statsMo');return;}const all=sn.val();let total=0,mine=0,media=0,first=null,words=0;for(let id in all){const m=all[id];if((m.from===CU.id&&m.to===CC.id)||(m.from===CC.id&&m.to===CU.id)){total++;if(m.from===CU.id)mine++;if(m.type&&m.type!=='sticker')media++;if(!first||m.timestamp<first)first=m.timestamp;if(m.from===CU.id&&m.text)words+=(m.text.match(/\S+/g)||[]).length;}}document.getElementById('st-total').textContent=total;document.getElementById('st-mine').textContent=mine;document.getElementById('st-media').textContent=media;document.getElementById('st-firstMsg').textContent=first?`üìÖ –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${new Date(first).toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'})}`:'' ;document.getElementById('st-words').textContent=`üí¨ –°–ª–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${words}`;om2('statsMo');}

/* HARD+ */
function openHardPlus(){
  const active=S.hardPlus;
  document.getElementById('hpStatus').textContent=active?'‚úÖ Hard+ –∞–∫—Ç–∏–≤–µ–Ω':'–í–≤–µ–¥–∏ –ø—Ä–æ–º–æ–∫–æ–¥ —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
  document.getElementById('hpPromoSection').style.display=active?'none':'block';
  document.getElementById('hp-badge-ctrl').style.display=active?'block':'none';
  document.getElementById('hp-status-ctrl').style.display=active?'block':'none';
  document.getElementById('hp-themes-ctrl').style.display=active?'block':'none';
  if(active&&CU.hardPlusTitle)document.getElementById('titleInp').value=CU.hardPlusTitle;
  if(active&&CU.statusText)document.getElementById('statusInp').value=CU.statusText;
  om2('hpm');
}
function activateHardPlus(){const code=document.getElementById('hpCodeInp').value.trim();if(code==='228'){sv('hardPlus',true);document.getElementById('hpStatus').textContent='üéâ Hard+ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!';document.getElementById('hpPromoSection').style.display='none';document.getElementById('menuHPBadge').style.display='';document.getElementById('hp-badge-ctrl').style.display='block';document.getElementById('hp-status-ctrl').style.display='block';document.getElementById('hp-themes-ctrl').style.display='block';toast('‚≠ê HARD+ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!','ok');}else{toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥','err');}}
function setTheme(name){document.body.className=document.body.className.replace(/theme-\w+/g,'').trim();if(name!=='default')document.body.classList.add('theme-'+name);sv('theme',name);document.querySelectorAll('.theme-btn').forEach(b=>{b.classList.toggle('on',b.textContent.toLowerCase()===name||(name==='default'&&b.textContent==='Default'));});toast('üé® –¢–µ–º–∞: '+name,'ok');}
async function applyUserTitle(){if(!S.hardPlus)return toast('–ù—É–∂–µ–Ω Hard+','err');const t=document.getElementById('titleInp').value.trim().substring(0,12);if(!t)return toast('–í–≤–µ–¥–∏ —Ç–∞–π—Ç–ª','err');try{await update(ref(db,`users/${CU.id}`),{hardPlusTitle:t,hardPlusTitleColor:S.titleColor||'#f0b429'});CU.hardPlusTitle=t;CU.hardPlusTitleColor=S.titleColor||'#f0b429';toast('‚úì –¢–∞–π—Ç–ª: '+t,'ok');}catch(e){toast('–û—à–∏–±–∫–∞','err');}}
async function clearUserTitle(){try{await update(ref(db,`users/${CU.id}`),{hardPlusTitle:null,hardPlusTitleColor:null});CU.hardPlusTitle=null;toast('‚úì –¢–∞–π—Ç–ª —É–±—Ä–∞–Ω','ok');}catch(e){}}
function setTitleColor(hex){sv('titleColor',hex);}
async function applyStatusText(){if(!S.hardPlus)return toast('–ù—É–∂–µ–Ω Hard+','err');const t=document.getElementById('statusInp').value.trim().substring(0,40);try{await update(ref(db,`users/${CU.id}`),{statusText:t});CU.statusText=t;toast(t?'‚úì –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞–Ω':'‚úì –°—Ç–∞—Ç—É—Å —É–±—Ä–∞–Ω','ok');}catch(e){toast('–û—à–∏–±–∫–∞','err');}}
async function quickStatus(t){document.getElementById('statusInp').value=t;applyStatusText();}



/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò v4.4
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ –ó–ê–ö–†–ï–ü–õ–Å–ù–ù–´–ï –ß–ê–¢–´ ‚îÄ‚îÄ
let pinnedChats = JSON.parse(localStorage.getItem('hard_pinned')||'[]');

function togglePinChat(id){
  const idx = pinnedChats.indexOf(id);
  if(idx >= 0) pinnedChats.splice(idx,1);
  else pinnedChats.unshift(id);
  localStorage.setItem('hard_pinned', JSON.stringify(pinnedChats));
  renderChats(chatContacts);
  toast(idx>=0?'üìå –û—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ':'üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ','ok');
}

// ‚îÄ‚îÄ –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ –í –°–ü–ò–°–ö–ï –ß–ê–¢–û–í ‚îÄ‚îÄ
let _ctxTarget = null;
function showChatCtx(e, contact){
  e.preventDefault();
  e.stopPropagation();
  closeChatCtx();
  _ctxTarget = contact;
  const isGC = contact.isGroup || contact.isChannel;
  const isPinned = pinnedChats.includes(contact.id);
  const isStarred = !isGC && starredContacts.includes(contact.id);
  const menu = document.createElement('div');
  menu.className = 'chat-ctx';
  menu.id = 'chatCtxMenu';
  const items = [
    {icon:'üìå', label: isPinned?'–û—Ç–∫—Ä–µ–ø–∏—Ç—å':'–ó–∞–∫—Ä–µ–ø–∏—Ç—å', fn:`togglePinChat('${contact.id}')`},
    ...(isGC ? [] : [{icon: isStarred?'‚≠ê':'‚òÜ', label: isStarred?'–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö':'–í –∏–∑–±—Ä–∞–Ω–Ω—ã–µ', fn:`toggleStar('${contact.id}')`}]),
    ...(isGC ? [{icon:'‚ÑπÔ∏è', label:'–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ', fn:`openGroupInfoDirect('${contact.id}')`}] : []),
    {icon:'üîï', label:'–ó–∞–≥–ª—É—à–∏—Ç—å', fn:`openMuteModalFor('${contact.id}')`},
    {icon:'üóëÔ∏è', label: isGC?(contact.isChannel&&contact.members&&contact.members[CU.id]==='admin'?'–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª':'–ü–æ–∫–∏–Ω—É—Ç—å'):'–£–¥–∞–ª–∏—Ç—å —á–∞—Ç', fn:`quickDeleteChat('${contact.id}', ${JSON.stringify(isGC)}, ${JSON.stringify(contact.isChannel||false)})`, danger:true},
  ];
  items.forEach(it=>{
    const d = document.createElement('div');
    d.className = 'chat-ctx-item' + (it.danger?' danger':'');
    d.innerHTML = `<span>${it.icon}</span><span>${it.label}</span>`;
    d.onclick = ()=>{ eval(it.fn); closeChatCtx(); };
    menu.appendChild(d);
  });
  // Position
  let x = e.clientX, y = e.clientY;
  document.body.appendChild(menu);
  const mw = menu.offsetWidth, mh = menu.offsetHeight;
  if(x + mw > window.innerWidth) x = window.innerWidth - mw - 8;
  if(y + mh > window.innerHeight) y = window.innerHeight - mh - 8;
  menu.style.left = x+'px';
  menu.style.top = y+'px';
  setTimeout(()=>document.addEventListener('click', closeChatCtx, {once:true}), 50);
}

function closeChatCtx(){
  const m = document.getElementById('chatCtxMenu');
  if(m) m.remove();
  _ctxTarget = null;
}

// –û—Ç–∫—Ä—ã—Ç—å –∏–Ω—Ñ–æ –≥—Ä—É–ø–ø—ã –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
function openGroupInfoDirect(gcId){
  const gc = groupContacts.find(g=>g.id===gcId);
  if(gc){ CC=gc; openGroupInfo(); }
}

// –ó–∞–≥–ª—É—à–∏—Ç—å –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é (–±–µ–∑ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞)
function openMuteModalFor(uid){
  // –í—Ä–µ–º–µ–Ω–Ω–æ —Å—Ç–∞–≤–∏–º —Ü–µ–ª—å –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª
  const prev = CC;
  const c = chatContacts.find(x=>x.id===uid) || groupContacts.find(x=>x.id===uid);
  if(c) CC = c;
  openMuteModal();
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ—à–ª–∏ –≤ —á–∞—Ç
  if(!document.getElementById('viewChat').classList.contains('on')) setTimeout(()=>{CC=prev;},300);
}

// ‚îÄ‚îÄ –ë–´–°–¢–†–û–ï –£–î–ê–õ–ï–ù–ò–ï –ò–ó –°–ü–ò–°–ö–ê –ß–ê–¢–û–í ‚îÄ‚îÄ
async function quickDeleteChat(id, isGC, isChannel){
  const contact = isGC
    ? groupContacts.find(g=>g.id===id)
    : chatContacts.find(c=>c.id===id);
  if(!contact) return;

  if(isGC){
    // –ì—Ä—É–ø–ø–∞/–∫–∞–Ω–∞–ª ‚Äî –ø–æ–∫–∏–Ω—É—Ç—å (–∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –µ—Å–ª–∏ –∞–¥–º–∏–Ω)
    const isAdmin = contact.members && contact.members[CU.id]==='admin';
    const label = isAdmin ? '–£–¥–∞–ª–∏—Ç—å' : '–ü–æ–∫–∏–Ω—É—Ç—å';
    const name = contact.name||'—á–∞—Ç';
    document.getElementById('cft').textContent = label+' "'+name+'"';
    document.getElementById('cfs').textContent = isAdmin
      ? '–ì—Ä—É–ø–ø–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.'
      : '–í—ã –ø–æ–∫–∏–Ω–µ—Ç–µ –≥—Ä—É–ø–ø—É. –í–∞—Å –º–æ–∂–Ω–æ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ.';
    document.getElementById('cfb').onclick = async ()=>{
      cm2('cfm');
      const path = isChannel ? 'channels' : 'groups';
      if(isAdmin){
        try{
          await remove(ref(db,`${path}/${id}`));
          const msgPath = isChannel ? `channelMsgs/${id}` : `groupMsgs/${id}`;
          await remove(ref(db,msgPath));
          groupContacts = groupContacts.filter(g=>g.id!==id);
          renderChats(chatContacts);
          toast('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ','ok');
        }catch(e){toast('–û—à–∏–±–∫–∞','err');}
      } else {
        try{
          await remove(ref(db,`${path}/${id}/members/${CU.id}`));
          groupContacts = groupContacts.filter(g=>g.id!==id);
          renderChats(chatContacts);
          toast('üëã –ü–æ–∫–∏–Ω—É–ª–∏ –≥—Ä—É–ø–ø—É','ok');
        }catch(e){toast('–û—à–∏–±–∫–∞','err');}
      }
    };
    om2('cfm');
  } else {
    // –õ–∏—á–Ω—ã–π —á–∞—Ç ‚Äî —É–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É
    document.getElementById('cft').textContent = '–£–¥–∞–ª–∏—Ç—å —á–∞—Ç';
    document.getElementById('cfs').textContent = '–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É —Å '+eh(contact.username)+'?';
    document.getElementById('cfb').onclick = async ()=>{
      cm2('cfm');
      try{
        const sn = await get(ref(db,'messages'));
        if(sn.exists()){
          for(let mid in sn.val()){
            const m = sn.val()[mid];
            if((m.from===CU.id&&m.to===id)||(m.from===id&&m.to===CU.id))
              await remove(ref(db,`messages/${mid}`));
          }
        }
        chatContacts = chatContacts.filter(c=>c.id!==id);
        contactLastMsgCache[id]=null;
        renderChats(chatContacts);
        toast('üóëÔ∏è –ß–∞—Ç —É–¥–∞–ª—ë–Ω','ok');
      }catch(e){toast('–û—à–∏–±–∫–∞','err');}
    };
    om2('cfm');
  }
}

// ‚îÄ‚îÄ –ü–ï–†–ï–†–ï–ù–î–ï–† –ß–ê–¢–û–í –° –£–ß–Å–¢–û–ú –ó–ê–ö–†–ï–ü–õ–Å–ù–ù–´–• ‚îÄ‚îÄ
// (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º renderChats)
const _origRenderChats = renderChats;

// ‚îÄ‚îÄ –°–ß–Å–¢–ß–ò–ö –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–• –í –ó–ê–ì–û–õ–û–í–ö–ï ‚îÄ‚îÄ
function updateTitleUnread(){
  let total = 0;
  for(let id in unread) total += (unread[id]||0);
  document.title = total > 0 ? `(${total}) HARD Messenger` : 'HARD Messenger';
}

// ‚îÄ‚îÄ –ë–´–°–¢–†–´–ô –û–¢–í–ï–¢ –ü–û –°–í–ê–ô–ü–£ ‚îÄ‚îÄ (touch devices)
(function initSwipeReply(){
  let startX=0, startY=0, swipeEl=null;
  document.addEventListener('touchstart', e=>{
    const msg = e.target.closest('.mw');
    if(!msg) return;
    startX=e.touches[0].clientX; startY=e.touches[0].clientY; swipeEl=msg;
  }, {passive:true});
  document.addEventListener('touchmove', e=>{
    if(!swipeEl) return;
    const dx=e.touches[0].clientX-startX, dy=e.touches[0].clientY-startY;
    if(Math.abs(dy)>Math.abs(dx)) return;
    if(dx<-30 && Math.abs(dx)>Math.abs(dy)*2){
      swipeEl.style.transform=`translateX(${Math.max(dx,-60)}px)`;
    }
  }, {passive:true});
  document.addEventListener('touchend', e=>{
    if(!swipeEl) return;
    const dx=e.changedTouches[0].clientX-startX;
    swipeEl.style.transition='transform .2s';
    swipeEl.style.transform='';
    if(dx<-50){
      const mid=swipeEl.dataset.mid;
      if(mid){
        // find msg data
        const mb=swipeEl.querySelector('.mb');
        const txt=mb?mb.textContent.trim().substring(0,50):'';
        const from=swipeEl.classList.contains('out')?(CU?CU.username:'–≤—ã'):(CC?CC.username:'');
        setReply(mid,txt,from);
        if(navigator.vibrate) navigator.vibrate(30);
      }
    }
    setTimeout(()=>{if(swipeEl)swipeEl.style.transition='';swipeEl=null;},200);
  }, {passive:true});
})();

/* ‚ïê‚ïê –ö–û–ù–ï–¶ –ù–û–í–´–• –§–£–ù–ö–¶–ò–ô ‚ïê‚ïê */

Object.assign(window,expose);
}; // end _hardMainInit

// –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É ‚Äî shim –≥–æ—Ç–æ–≤ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è
if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', window._hardMainInit);
} else {
  window._hardMainInit();
}
</script>

<!-- ‚ïê‚ïê CREATE GROUP/CHANNEL MODAL ‚ïê‚ïê -->
<div class="mo" id="gcMo"><div class="mc">
  <div class="mc-t">–°–æ–∑–¥–∞—Ç—å</div>
  <div class="gc-type-tabs">
    <div class="gc-tab on" id="gcTabGrp" onclick="setGcType('group')">üë• –ì—Ä—É–ø–ø–∞</div>
    <div class="gc-tab" id="gcTabChn" onclick="setGcType('channel')">üì¢ –ö–∞–Ω–∞–ª</div>
  </div>
  <input class="gc-inp" id="gcName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ...">
  <div id="gcMembersWrap">
    <div style="font-size:11px;color:var(--txt3);margin-bottom:6px;font-family:'IBM Plex Mono',monospace;">–£–ß–ê–°–¢–ù–ò–ö–ò</div>
    <div class="gc-member-list" id="gcMemberList"></div>
  </div>
  <div class="mac">
    <button class="mbtn sec" onclick="cm2('gcMo')">–û—Ç–º–µ–Ω–∞</button>
    <button class="mbtn prim" onclick="createGroupOrChannel()">–°–æ–∑–¥–∞—Ç—å</button>
  </div>
</div></div>

<!-- ‚ïê‚ïê GROUP INFO MODAL ‚ïê‚ïê -->
<div class="mo" id="grpInfoMo"><div class="mc">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
    <img id="grpInfoAva" src="" style="width:48px;height:48px;border-radius:10px;object-fit:cover;border:1px solid var(--p3);">
    <div>
      <div class="mc-t" id="grpInfoName" style="margin-bottom:2px;">‚Äî</div>
      <div style="font-size:11px;color:var(--txt3);" id="grpInfoType">–ì—Ä—É–ø–ø–∞</div>
    </div>
  </div>
  <div style="font-size:11px;color:var(--txt3);font-family:'IBM Plex Mono',monospace;margin-bottom:6px;">–£–ß–ê–°–¢–ù–ò–ö–ò</div>
  <div class="grp-members-list" id="grpMembersList"></div>
  <div id="grpAddWrap" style="margin-top:10px;border-top:1px solid var(--p3);padding-top:10px;">
    <div style="font-size:11px;color:var(--txt3);font-family:'IBM Plex Mono',monospace;margin-bottom:6px;">–î–û–ë–ê–í–ò–¢–¨</div>
    <div class="gc-member-list" id="grpAddList"></div>
  </div>
  <div class="mac" style="margin-top:12px;">
    <button class="mbtn dng" id="grpLeaveBtn" onclick="leaveGroup()">–ü–æ–∫–∏–Ω—É—Ç—å</button>
    <button class="mbtn sec" onclick="cm2('grpInfoMo')">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div></div>

</body>
</html>
